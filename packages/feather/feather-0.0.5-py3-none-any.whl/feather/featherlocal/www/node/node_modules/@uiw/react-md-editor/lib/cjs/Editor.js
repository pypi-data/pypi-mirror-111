"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _reactMarkdownPreview = _interopRequireDefault(require("@uiw/react-markdown-preview"));

var _TextArea = _interopRequireDefault(require("./components/TextArea"));

var _Toolbar = _interopRequireDefault(require("./components/Toolbar"));

var _DragBar = _interopRequireDefault(require("./components/DragBar"));

var _commands = require("./commands");

var _Context = require("./Context");

var _excluded = ["prefixCls", "className", "value", "commands", "extraCommands", "height", "toolbarHeight", "enableScroll", "visiableDragbar", "highlightEnable", "preview", "fullscreen", "previewOptions", "textareaProps", "maxHeight", "minHeight", "autoFocus", "tabSize", "onChange", "hideToolbar", "renderTextarea"];

function setGroupPopFalse() {
  var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  Object.keys(data).forEach(function (keyname) {
    data[keyname] = false;
  });
  return data;
}

var InternalMDEditor = function InternalMDEditor(props, ref) {
  var _ref = props || {},
      _ref$prefixCls = _ref.prefixCls,
      prefixCls = _ref$prefixCls === void 0 ? 'w-md-editor' : _ref$prefixCls,
      className = _ref.className,
      propsValue = _ref.value,
      _ref$commands = _ref.commands,
      commands = _ref$commands === void 0 ? (0, _commands.getCommands)() : _ref$commands,
      _ref$extraCommands = _ref.extraCommands,
      extraCommands = _ref$extraCommands === void 0 ? (0, _commands.getExtraCommands)() : _ref$extraCommands,
      _ref$height = _ref.height,
      height = _ref$height === void 0 ? 200 : _ref$height,
      _ref$toolbarHeight = _ref.toolbarHeight,
      toolbarHeight = _ref$toolbarHeight === void 0 ? 29 : _ref$toolbarHeight,
      _ref$enableScroll = _ref.enableScroll,
      enableScroll = _ref$enableScroll === void 0 ? true : _ref$enableScroll,
      _ref$visiableDragbar = _ref.visiableDragbar,
      visiableDragbar = _ref$visiableDragbar === void 0 ? true : _ref$visiableDragbar,
      _ref$highlightEnable = _ref.highlightEnable,
      highlightEnable = _ref$highlightEnable === void 0 ? true : _ref$highlightEnable,
      _ref$preview = _ref.preview,
      previewType = _ref$preview === void 0 ? 'live' : _ref$preview,
      _ref$fullscreen = _ref.fullscreen,
      fullscreen = _ref$fullscreen === void 0 ? false : _ref$fullscreen,
      _ref$previewOptions = _ref.previewOptions,
      previewOptions = _ref$previewOptions === void 0 ? {} : _ref$previewOptions,
      textareaProps = _ref.textareaProps,
      _ref$maxHeight = _ref.maxHeight,
      maxHeight = _ref$maxHeight === void 0 ? 1200 : _ref$maxHeight,
      _ref$minHeight = _ref.minHeight,
      minHeight = _ref$minHeight === void 0 ? 100 : _ref$minHeight,
      autoFocus = _ref.autoFocus,
      _ref$tabSize = _ref.tabSize,
      tabSize = _ref$tabSize === void 0 ? 2 : _ref$tabSize,
      onChange = _ref.onChange,
      hideToolbar = _ref.hideToolbar,
      renderTextarea = _ref.renderTextarea,
      other = (0, _objectWithoutProperties2.default)(_ref, _excluded);

  var _useReducer = (0, _react.useReducer)(_Context.reducer, {
    markdown: propsValue,
    preview: previewType,
    height: height,
    highlightEnable: highlightEnable,
    tabSize: tabSize,
    scrollTop: 0,
    scrollTopPreview: 0,
    commands: commands,
    extraCommands: extraCommands,
    fullscreen: fullscreen,
    onChange: onChange,
    barPopup: {}
  }),
      _useReducer2 = (0, _slicedToArray2.default)(_useReducer, 2),
      state = _useReducer2[0],
      dispatch = _useReducer2[1];

  var container = (0, _react.useRef)(null);
  var previewRef = (0, _react.useRef)(null);
  var enableScrollRef = (0, _react.useRef)(enableScroll);
  (0, _react.useImperativeHandle)(ref, function () {
    return (0, _objectSpread2.default)({}, state);
  });
  (0, _react.useMemo)(function () {
    return enableScrollRef.current = enableScroll;
  }, [enableScroll]);
  (0, _react.useEffect)(function () {
    var stateInit = {};

    if (container.current) {
      stateInit.container = container.current || undefined;
    }

    stateInit.markdown = propsValue || '';
    stateInit.barPopup = {};

    if (dispatch) {
      dispatch((0, _objectSpread2.default)((0, _objectSpread2.default)({}, state), stateInit));
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var cls = [className, prefixCls, state.preview ? "".concat(prefixCls, "-show-").concat(state.preview) : null, state.fullscreen ? "".concat(prefixCls, "-fullscreen") : null].filter(Boolean).join(' ').trim();
  (0, _react.useMemo)(function () {
    return propsValue !== state.markdown && dispatch({
      markdown: propsValue || ''
    });
  }, [propsValue, state.markdown]); // eslint-disable-next-line react-hooks/exhaustive-deps

  (0, _react.useMemo)(function () {
    return previewType !== state.preview && dispatch({
      preview: previewType
    });
  }, [previewType]); // eslint-disable-next-line react-hooks/exhaustive-deps

  (0, _react.useMemo)(function () {
    return height !== state.height && dispatch({
      height: height
    });
  }, [height]); // eslint-disable-next-line react-hooks/exhaustive-deps

  (0, _react.useMemo)(function () {
    return tabSize !== state.tabSize && dispatch({
      tabSize: tabSize
    });
  }, [tabSize]);
  (0, _react.useMemo)(function () {
    return highlightEnable !== state.highlightEnable && dispatch({
      highlightEnable: highlightEnable
    });
  }, // eslint-disable-next-line react-hooks/exhaustive-deps
  [highlightEnable]); // eslint-disable-next-line react-hooks/exhaustive-deps

  (0, _react.useMemo)(function () {
    return autoFocus !== state.autoFocus && dispatch({
      autoFocus: autoFocus
    });
  }, [autoFocus]);
  (0, _react.useMemo)(function () {
    return fullscreen !== state.fullscreen && dispatch({
      fullscreen: fullscreen
    });
  }, // eslint-disable-next-line react-hooks/exhaustive-deps
  [fullscreen]);
  var textareaDomRef = (0, _react.useRef)();
  var active = (0, _react.useRef)('preview');
  var initScroll = (0, _react.useRef)(false);
  (0, _react.useMemo)(function () {
    textareaDomRef.current = state.textareaWarp;

    if (state.textareaWarp) {
      state.textareaWarp.addEventListener('mouseover', function () {
        active.current = 'text';
      });
      state.textareaWarp.addEventListener('mouseleave', function () {
        active.current = 'preview';
      });
    }
  }, [state.textareaWarp]);

  var handleScroll = function handleScroll(e, type) {
    if (!enableScrollRef.current) return;
    var textareaDom = textareaDomRef.current;
    var previewDom = previewRef.current ? previewRef.current.mdp.current : undefined;

    if (!initScroll.current) {
      active.current = type;
      initScroll.current = true;
    }

    if (textareaDom && previewDom) {
      var scale = (textareaDom.scrollHeight - textareaDom.offsetHeight) / (previewDom.scrollHeight - previewDom.offsetHeight);

      if (e.target === textareaDom && active.current === 'text') {
        previewDom.scrollTop = textareaDom.scrollTop / scale;
      }

      if (e.target === previewDom && active.current === 'preview') {
        textareaDom.scrollTop = previewDom.scrollTop * scale;
      }

      var scrollTop = 0;

      if (active.current === 'text') {
        scrollTop = textareaDom.scrollTop || 0;
      } else if (active.current === 'preview') {
        scrollTop = previewDom.scrollTop || 0;
      }

      dispatch({
        scrollTop: scrollTop
      });
    }
  };

  return /*#__PURE__*/_react.default.createElement(_Context.EditorContext.Provider, {
    value: (0, _objectSpread2.default)((0, _objectSpread2.default)({}, state), {}, {
      dispatch: dispatch
    })
  }, /*#__PURE__*/_react.default.createElement("div", (0, _extends2.default)({
    ref: container,
    className: cls
  }, other, {
    onClick: function onClick() {
      dispatch({
        barPopup: (0, _objectSpread2.default)({}, setGroupPopFalse(state.barPopup))
      });
    },
    style: (0, _objectSpread2.default)((0, _objectSpread2.default)({}, other.style), {}, {
      height: state.fullscreen ? '100%' : hideToolbar ? Number(state.height) - toolbarHeight : state.height
    })
  }), !hideToolbar && /*#__PURE__*/_react.default.createElement(_Toolbar.default, {
    prefixCls: prefixCls,
    height: toolbarHeight
  }), /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-content"),
    style: {
      height: state.fullscreen ? "calc(100% - ".concat(toolbarHeight, "px)") : Number(state.height) - toolbarHeight
    }
  }, /(edit|live)/.test(state.preview || '') && /*#__PURE__*/_react.default.createElement(_TextArea.default, (0, _extends2.default)({
    className: "".concat(prefixCls, "-input"),
    prefixCls: prefixCls,
    autoFocus: autoFocus
  }, textareaProps, {
    renderTextarea: renderTextarea,
    onScroll: function onScroll(e) {
      return handleScroll(e, 'text');
    }
  })), /(live|preview)/.test(state.preview || '') && /*#__PURE__*/_react.default.createElement(_reactMarkdownPreview.default, (0, _extends2.default)({}, previewOptions, {
    onScroll: function onScroll(e) {
      return handleScroll(e, 'preview');
    },
    ref: previewRef,
    source: state.markdown || '',
    className: "".concat(prefixCls, "-preview")
  }))), visiableDragbar && !state.fullscreen && /*#__PURE__*/_react.default.createElement(_DragBar.default, {
    prefixCls: prefixCls,
    height: state.height,
    maxHeight: maxHeight,
    minHeight: minHeight,
    onChange: function onChange(newHeight) {
      dispatch({
        height: newHeight
      });
    }
  })));
};

var mdEditor = /*#__PURE__*/_react.default.forwardRef(InternalMDEditor);

mdEditor.Markdown = _reactMarkdownPreview.default;
var _default = mdEditor;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FZGl0b3IudHN4Il0sIm5hbWVzIjpbInNldEdyb3VwUG9wRmFsc2UiLCJkYXRhIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXluYW1lIiwiSW50ZXJuYWxNREVkaXRvciIsInByb3BzIiwicmVmIiwicHJlZml4Q2xzIiwiY2xhc3NOYW1lIiwicHJvcHNWYWx1ZSIsInZhbHVlIiwiY29tbWFuZHMiLCJleHRyYUNvbW1hbmRzIiwiaGVpZ2h0IiwidG9vbGJhckhlaWdodCIsImVuYWJsZVNjcm9sbCIsInZpc2lhYmxlRHJhZ2JhciIsImhpZ2hsaWdodEVuYWJsZSIsInByZXZpZXciLCJwcmV2aWV3VHlwZSIsImZ1bGxzY3JlZW4iLCJwcmV2aWV3T3B0aW9ucyIsInRleHRhcmVhUHJvcHMiLCJtYXhIZWlnaHQiLCJtaW5IZWlnaHQiLCJhdXRvRm9jdXMiLCJ0YWJTaXplIiwib25DaGFuZ2UiLCJoaWRlVG9vbGJhciIsInJlbmRlclRleHRhcmVhIiwib3RoZXIiLCJyZWR1Y2VyIiwibWFya2Rvd24iLCJzY3JvbGxUb3AiLCJzY3JvbGxUb3BQcmV2aWV3IiwiYmFyUG9wdXAiLCJzdGF0ZSIsImRpc3BhdGNoIiwiY29udGFpbmVyIiwicHJldmlld1JlZiIsImVuYWJsZVNjcm9sbFJlZiIsImN1cnJlbnQiLCJzdGF0ZUluaXQiLCJ1bmRlZmluZWQiLCJjbHMiLCJmaWx0ZXIiLCJCb29sZWFuIiwiam9pbiIsInRyaW0iLCJ0ZXh0YXJlYURvbVJlZiIsImFjdGl2ZSIsImluaXRTY3JvbGwiLCJ0ZXh0YXJlYVdhcnAiLCJhZGRFdmVudExpc3RlbmVyIiwiaGFuZGxlU2Nyb2xsIiwiZSIsInR5cGUiLCJ0ZXh0YXJlYURvbSIsInByZXZpZXdEb20iLCJtZHAiLCJzY2FsZSIsInNjcm9sbEhlaWdodCIsIm9mZnNldEhlaWdodCIsInRhcmdldCIsInN0eWxlIiwiTnVtYmVyIiwidGVzdCIsIm5ld0hlaWdodCIsIm1kRWRpdG9yIiwiUmVhY3QiLCJm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YUFBT0QsWUFBWSxDQUFDQyxDQUFELEVBQUksTUFBSixDQUFuQjtBQUFBO0FBTlosS0FQSixFQWdCRyxpQkFBaUJXLElBQWpCLENBQXNCOUIsS0FBSyxDQUFDbEIsT0FBTixJQUFpQixFQUF2QyxrQkFDQyw2QkFBQyw2QkFBRCw2QkFDT0csY0FEUDtBQUVFLElBQUEsUUFBUSxFQUFFLGtCQUFDa0MsQ0FBRDtBQUFBLGFBQU9ELFlBQVksQ0FBQ0MsQ0FBRCxFQUFJLFNBQUosQ0FBbkI7QUFBQSxLQUZaO0FBR0UsSUFBQSxHQUFHLEVBQUVoQixVQUhQO0FBSUUsSUFBQSxNQUFNLEVBQUVILEtBQUssQ0FBQ0osUUFBTixJQUFrQixFQUo1QjtBQUtFLElBQUEsU0FBUyxZQUFLekIsU0FBTDtBQUxYLEtBakJKLENBYkYsRUF1Q0dTLGVBQWUsSUFBSSxDQUFDb0IsS0FBSyxDQUFDaEIsVUFBMUIsaUJBQ0MsNkJBQUMsZ0JBQUQ7QUFDRSxJQUFBLFNBQVMsRUFBRWIsU0FEYjtBQUVFLElBQUEsTUFBTSxFQUFFNkIsS0FBSyxDQUFDdkIsTUFGaEI7QUFHRSxJQUFBLFNBQVMsRUFBRVUsU0FIYjtBQUlFLElBQUEsU0FBUyxFQUFFQyxTQUpiO0FBS0UsSUFBQSxRQUFRLEVBQUUsa0JBQUMyQyxTQUFELEVBQWU7QUFDdkI5QixNQUFBQSxRQUFRLENBQUM7QUFBRXhCLFFBQUFBLE1BQU0sRUFBRXNEO0FBQVYsT0FBRCxDQUFSO0FBQ0Q7QUFQSCxJQXhDSixDQURGLENBREY7QUF1REQsQ0FoTUQ7O0FBa01BLElBQU1DLFFBQVEsZ0JBQUdDLGVBQU1DLFVBQU4sQ0FBOENsRSxnQkFBOUMsQ0FBakI7O0FBTUNnRSxRQUFELENBQXVCRyxRQUF2QixHQUFrQ0MsNkJBQWxDO2VBRWVKLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlRWZmZWN0LCB1c2VSZWR1Y2VyLCB1c2VNZW1vLCB1c2VSZWYsIHVzZUltcGVyYXRpdmVIYW5kbGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgTWFya2Rvd25QcmV2aWV3LCB7IE1hcmtkb3duUHJldmlld1Byb3BzLCBNYXJrZG93blByZXZpZXdSZWYgfSBmcm9tICdAdWl3L3JlYWN0LW1hcmtkb3duLXByZXZpZXcnO1xuaW1wb3J0IHsgSVByb3BzIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgVGV4dEFyZWEsIHsgSVRleHRBcmVhUHJvcHMgfSBmcm9tICcuL2NvbXBvbmVudHMvVGV4dEFyZWEnO1xuaW1wb3J0IFRvb2xiYXIgZnJvbSAnLi9jb21wb25lbnRzL1Rvb2xiYXInO1xuaW1wb3J0IERyYWdCYXIgZnJvbSAnLi9jb21wb25lbnRzL0RyYWdCYXInO1xuaW1wb3J0IHsgZ2V0Q29tbWFuZHMsIGdldEV4dHJhQ29tbWFuZHMsIElDb21tYW5kIH0gZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgeyByZWR1Y2VyLCBFZGl0b3JDb250ZXh0LCBDb250ZXh0U3RvcmUsIFByZXZpZXdUeXBlIH0gZnJvbSAnLi9Db250ZXh0JztcbmltcG9ydCAnLi9pbmRleC5sZXNzJztcblxuZXhwb3J0IGludGVyZmFjZSBNREVkaXRvclByb3BzIGV4dGVuZHMgT21pdDxSZWFjdC5IVE1MQXR0cmlidXRlczxIVE1MRGl2RWxlbWVudD4sICdvbkNoYW5nZSc+LCBJUHJvcHMge1xuICAvKipcbiAgICogVGhlIE1hcmtkb3duIHZhbHVlLlxuICAgKi9cbiAgdmFsdWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBFdmVudCBoYW5kbGVyIGZvciB0aGUgYG9uQ2hhbmdlYCBldmVudC5cbiAgICovXG4gIG9uQ2hhbmdlPzogKHZhbHVlPzogc3RyaW5nKSA9PiB2b2lkO1xuICAvKipcbiAgICogQ2FuIGJlIHVzZWQgdG8gbWFrZSBgTWFya2Rvd24gRWRpdG9yYCBmb2N1cyBpdHNlbGYgb24gaW5pdGlhbGl6YXRpb24uIERlZmF1bHRzIHRvIG9uLlxuICAgKiBpdCB3aWxsIGJlIHNldCB0byB0cnVlIHdoZW4gZWl0aGVyIHRoZSBzb3VyY2UgYHRleHRhcmVhYCBpcyBmb2N1c2VkLFxuICAgKiBvciBpdCBoYXMgYW4gYGF1dG9mb2N1c2AgYXR0cmlidXRlIGFuZCBubyBvdGhlciBlbGVtZW50IGlzIGZvY3VzZWQuXG4gICAqL1xuICBhdXRvRm9jdXM/OiBJVGV4dEFyZWFQcm9wc1snYXV0b0ZvY3VzJ107XG4gIC8qKlxuICAgKiBUaGUgaGVpZ2h0IG9mIHRoZSBlZGl0b3IuXG4gICAqL1xuICBoZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBDdXN0b20gdG9vbGJhciBoZWlndGhcbiAgICogQGRlZmF1bHQgMjlweFxuICAgKi9cbiAgdG9vbGJhckhlaWdodD86IG51bWJlcjtcbiAgLyoqXG4gICAqIFNob3cgZHJhZyBhbmQgZHJvcCB0b29sLiBTZXQgdGhlIGhlaWdodCBvZiB0aGUgZWRpdG9yLlxuICAgKi9cbiAgdmlzaWFibGVEcmFnYmFyPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFNob3cgbWFya2Rvd24gcHJldmlldy5cbiAgICovXG4gIHByZXZpZXc/OiBQcmV2aWV3VHlwZTtcbiAgLyoqXG4gICAqIEZ1bGwgc2NyZWVuIGRpc3BsYXkgZWRpdG9yLlxuICAgKi9cbiAgZnVsbHNjcmVlbj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBNYXhpbXVtIGRyYWcgaGVpZ2h0LiBgdmlzaWFibGVEcmFnYmFyPXRydWVgXG4gICAqL1xuICBtYXhIZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBNaW5pbXVtIGRyYWcgaGVpZ2h0LiBgdmlzaWFibGVEcmFnYmFyPXRydWVgXG4gICAqL1xuICBtaW5IZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGlzIGlzIHJlc2V0IFtyZWFjdC1tYXJrZG93bl0oaHR0cHM6Ly9naXRodWIuY29tL3JleHhhcnMvcmVhY3QtbWFya2Rvd24pIHNldHRpbmdzLlxuICAgKi9cbiAgcHJldmlld09wdGlvbnM/OiBPbWl0PE1hcmtkb3duUHJldmlld1Byb3BzLCAnc291cmNlJz47XG4gIC8qKlxuICAgKiBTZXQgdGhlIGB0ZXh0YXJlYWAgcmVsYXRlZCBwcm9wcy5cbiAgICovXG4gIHRleHRhcmVhUHJvcHM/OiBJVGV4dEFyZWFQcm9wcztcbiAgLyoqIFVzZSBkaXYgdG8gcmVwbGFjZSBUZXh0QXJlYSBvciByZS1yZW5kZXIgVGV4dEFyZWEgKi9cbiAgcmVuZGVyVGV4dGFyZWE/OiBJVGV4dEFyZWFQcm9wc1sncmVuZGVyVGV4dGFyZWEnXTtcbiAgLyoqXG4gICAqIERpc2FibGUgZWRpdGluZyBhcmVhIGNvZGUgaGlnaGxpZ2h0aW5nLiBUaGUgdmFsdWUgaXMgYGZhbHNlYCwgd2hpY2ggaW5jcmVhc2VzIHRoZSBlZGl0aW5nIHNwZWVkLlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICBoaWdobGlnaHRFbmFibGU/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIHRvIGluc2VydCB3aGVuIHByZXNzaW5nIHRhYiBrZXkuXG4gICAqIERlZmF1bHQgYDJgIHNwYWNlcy5cbiAgICovXG4gIHRhYlNpemU/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBZb3UgY2FuIGNyZWF0ZSB5b3VyIG93biBjb21tYW5kcyBvciByZXVzZSBleGlzdGluZyBjb21tYW5kcy5cbiAgICovXG4gIGNvbW1hbmRzPzogSUNvbW1hbmRbXTtcbiAgLyoqXG4gICAqIFlvdSBjYW4gY3JlYXRlIHlvdXIgb3duIGNvbW1hbmRzIG9yIHJldXNlIGV4aXN0aW5nIGNvbW1hbmRzLlxuICAgKi9cbiAgZXh0cmFDb21tYW5kcz86IElDb21tYW5kW107XG4gIC8qKlxuICAgKiBIaWRlIHRoZSB0b29sIGJhclxuICAgKi9cbiAgaGlkZVRvb2xiYXI/OiBib29sZWFuO1xuICAvKiogV2hldGhlciB0byBlbmFibGUgc2Nyb2xsaW5nICovXG4gIGVuYWJsZVNjcm9sbD86IGJvb2xlYW47XG59XG5cbmZ1bmN0aW9uIHNldEdyb3VwUG9wRmFsc2UoZGF0YTogUmVjb3JkPHN0cmluZywgYm9vbGVhbj4gPSB7fSkge1xuICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKChrZXluYW1lKSA9PiB7XG4gICAgZGF0YVtrZXluYW1lXSA9IGZhbHNlO1xuICB9KTtcbiAgcmV0dXJuIGRhdGE7XG59XG5cbmNvbnN0IEludGVybmFsTURFZGl0b3IgPSAoXG4gIHByb3BzOiBNREVkaXRvclByb3BzLFxuICByZWY/OiAoKGluc3RhbmNlOiBDb250ZXh0U3RvcmUpID0+IHZvaWQpIHwgUmVhY3QuUmVmT2JqZWN0PENvbnRleHRTdG9yZT4gfCBudWxsLFxuKSA9PiB7XG4gIGNvbnN0IHtcbiAgICBwcmVmaXhDbHMgPSAndy1tZC1lZGl0b3InLFxuICAgIGNsYXNzTmFtZSxcbiAgICB2YWx1ZTogcHJvcHNWYWx1ZSxcbiAgICBjb21tYW5kcyA9IGdldENvbW1hbmRzKCksXG4gICAgZXh0cmFDb21tYW5kcyA9IGdldEV4dHJhQ29tbWFuZHMoKSxcbiAgICBoZWlnaHQgPSAyMDAsXG4gICAgdG9vbGJhckhlaWdodCA9IDI5LFxuICAgIGVuYWJsZVNjcm9sbCA9IHRydWUsXG4gICAgdmlzaWFibGVEcmFnYmFyID0gdHJ1ZSxcbiAgICBoaWdobGlnaHRFbmFibGUgPSB0cnVlLFxuICAgIHByZXZpZXc6IHByZXZpZXdUeXBlID0gJ2xpdmUnLFxuICAgIGZ1bGxzY3JlZW4gPSBmYWxzZSxcbiAgICBwcmV2aWV3T3B0aW9ucyA9IHt9LFxuICAgIHRleHRhcmVhUHJvcHMsXG4gICAgbWF4SGVpZ2h0ID0gMTIwMCxcbiAgICBtaW5IZWlnaHQgPSAxMDAsXG4gICAgYXV0b0ZvY3VzLFxuICAgIHRhYlNpemUgPSAyLFxuICAgIG9uQ2hhbmdlLFxuICAgIGhpZGVUb29sYmFyLFxuICAgIHJlbmRlclRleHRhcmVhLFxuICAgIC4uLm90aGVyXG4gIH0gPSBwcm9wcyB8fCB7fTtcbiAgbGV0IFtzdGF0ZSwgZGlzcGF0Y2hdID0gdXNlUmVkdWNlcihyZWR1Y2VyLCB7XG4gICAgbWFya2Rvd246IHByb3BzVmFsdWUsXG4gICAgcHJldmlldzogcHJldmlld1R5cGUsXG4gICAgaGVpZ2h0LFxuICAgIGhpZ2hsaWdodEVuYWJsZSxcbiAgICB0YWJTaXplLFxuICAgIHNjcm9sbFRvcDogMCxcbiAgICBzY3JvbGxUb3BQcmV2aWV3OiAwLFxuICAgIGNvbW1hbmRzLFxuICAgIGV4dHJhQ29tbWFuZHMsXG4gICAgZnVsbHNjcmVlbixcbiAgICBvbkNoYW5nZSxcbiAgICBiYXJQb3B1cDoge30sXG4gIH0pO1xuICBjb25zdCBjb250YWluZXIgPSB1c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuICBjb25zdCBwcmV2aWV3UmVmID0gdXNlUmVmPE1hcmtkb3duUHJldmlld1JlZj4obnVsbCk7XG4gIGNvbnN0IGVuYWJsZVNjcm9sbFJlZiA9IHVzZVJlZihlbmFibGVTY3JvbGwpO1xuXG4gIHVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCAoKSA9PiAoeyAuLi5zdGF0ZSB9KSk7XG4gIHVzZU1lbW8oKCkgPT4gKGVuYWJsZVNjcm9sbFJlZi5jdXJyZW50ID0gZW5hYmxlU2Nyb2xsKSwgW2VuYWJsZVNjcm9sbF0pO1xuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IHN0YXRlSW5pdDogQ29udGV4dFN0b3JlID0ge307XG4gICAgaWYgKGNvbnRhaW5lci5jdXJyZW50KSB7XG4gICAgICBzdGF0ZUluaXQuY29udGFpbmVyID0gY29udGFpbmVyLmN1cnJlbnQgfHwgdW5kZWZpbmVkO1xuICAgIH1cbiAgICBzdGF0ZUluaXQubWFya2Rvd24gPSBwcm9wc1ZhbHVlIHx8ICcnO1xuICAgIHN0YXRlSW5pdC5iYXJQb3B1cCA9IHt9O1xuICAgIGlmIChkaXNwYXRjaCkge1xuICAgICAgZGlzcGF0Y2goeyAuLi5zdGF0ZSwgLi4uc3RhdGVJbml0IH0pO1xuICAgIH1cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gIH0sIFtdKTtcblxuICBjb25zdCBjbHMgPSBbXG4gICAgY2xhc3NOYW1lLFxuICAgIHByZWZpeENscyxcbiAgICBzdGF0ZS5wcmV2aWV3ID8gYCR7cHJlZml4Q2xzfS1zaG93LSR7c3RhdGUucHJldmlld31gIDogbnVsbCxcbiAgICBzdGF0ZS5mdWxsc2NyZWVuID8gYCR7cHJlZml4Q2xzfS1mdWxsc2NyZWVuYCA6IG51bGwsXG4gIF1cbiAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgLmpvaW4oJyAnKVxuICAgIC50cmltKCk7XG5cbiAgdXNlTWVtbyhcbiAgICAoKSA9PiBwcm9wc1ZhbHVlICE9PSBzdGF0ZS5tYXJrZG93biAmJiBkaXNwYXRjaCh7IG1hcmtkb3duOiBwcm9wc1ZhbHVlIHx8ICcnIH0pLFxuICAgIFtwcm9wc1ZhbHVlLCBzdGF0ZS5tYXJrZG93bl0sXG4gICk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgdXNlTWVtbygoKSA9PiBwcmV2aWV3VHlwZSAhPT0gc3RhdGUucHJldmlldyAmJiBkaXNwYXRjaCh7IHByZXZpZXc6IHByZXZpZXdUeXBlIH0pLCBbcHJldmlld1R5cGVdKTtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICB1c2VNZW1vKCgpID0+IGhlaWdodCAhPT0gc3RhdGUuaGVpZ2h0ICYmIGRpc3BhdGNoKHsgaGVpZ2h0OiBoZWlnaHQgfSksIFtoZWlnaHRdKTtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICB1c2VNZW1vKCgpID0+IHRhYlNpemUgIT09IHN0YXRlLnRhYlNpemUgJiYgZGlzcGF0Y2goeyB0YWJTaXplIH0pLCBbdGFiU2l6ZV0pO1xuICB1c2VNZW1vKFxuICAgICgpID0+IGhpZ2hsaWdodEVuYWJsZSAhPT0gc3RhdGUuaGlnaGxpZ2h0RW5hYmxlICYmIGRpc3BhdGNoKHsgaGlnaGxpZ2h0RW5hYmxlIH0pLFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgICBbaGlnaGxpZ2h0RW5hYmxlXSxcbiAgKTtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICB1c2VNZW1vKCgpID0+IGF1dG9Gb2N1cyAhPT0gc3RhdGUuYXV0b0ZvY3VzICYmIGRpc3BhdGNoKHsgYXV0b0ZvY3VzOiBhdXRvRm9jdXMgfSksIFthdXRvRm9jdXNdKTtcbiAgdXNlTWVtbyhcbiAgICAoKSA9PiBmdWxsc2NyZWVuICE9PSBzdGF0ZS5mdWxsc2NyZWVuICYmIGRpc3BhdGNoKHsgZnVsbHNjcmVlbjogZnVsbHNjcmVlbiB9KSxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gICAgW2Z1bGxzY3JlZW5dLFxuICApO1xuXG4gIGNvbnN0IHRleHRhcmVhRG9tUmVmID0gdXNlUmVmPEhUTUxEaXZFbGVtZW50PigpO1xuICBjb25zdCBhY3RpdmUgPSB1c2VSZWY8J3RleHQnIHwgJ3ByZXZpZXcnPigncHJldmlldycpO1xuICBjb25zdCBpbml0U2Nyb2xsID0gdXNlUmVmKGZhbHNlKTtcblxuICB1c2VNZW1vKCgpID0+IHtcbiAgICB0ZXh0YXJlYURvbVJlZi5jdXJyZW50ID0gc3RhdGUudGV4dGFyZWFXYXJwO1xuICAgIGlmIChzdGF0ZS50ZXh0YXJlYVdhcnApIHtcbiAgICAgIHN0YXRlLnRleHRhcmVhV2FycC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCAoKSA9PiB7XG4gICAgICAgIGFjdGl2ZS5jdXJyZW50ID0gJ3RleHQnO1xuICAgICAgfSk7XG4gICAgICBzdGF0ZS50ZXh0YXJlYVdhcnAuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsICgpID0+IHtcbiAgICAgICAgYWN0aXZlLmN1cnJlbnQgPSAncHJldmlldyc7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sIFtzdGF0ZS50ZXh0YXJlYVdhcnBdKTtcblxuICBjb25zdCBoYW5kbGVTY3JvbGwgPSAoZTogUmVhY3QuVUlFdmVudDxIVE1MRGl2RWxlbWVudD4sIHR5cGU6ICd0ZXh0JyB8ICdwcmV2aWV3JykgPT4ge1xuICAgIGlmICghZW5hYmxlU2Nyb2xsUmVmLmN1cnJlbnQpIHJldHVybjtcbiAgICBjb25zdCB0ZXh0YXJlYURvbSA9IHRleHRhcmVhRG9tUmVmLmN1cnJlbnQ7XG4gICAgY29uc3QgcHJldmlld0RvbSA9IHByZXZpZXdSZWYuY3VycmVudCA/IHByZXZpZXdSZWYuY3VycmVudC5tZHAuY3VycmVudCA6IHVuZGVmaW5lZDtcbiAgICBpZiAoIWluaXRTY3JvbGwuY3VycmVudCkge1xuICAgICAgYWN0aXZlLmN1cnJlbnQgPSB0eXBlO1xuICAgICAgaW5pdFNjcm9sbC5jdXJyZW50ID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHRleHRhcmVhRG9tICYmIHByZXZpZXdEb20pIHtcbiAgICAgIGNvbnN0IHNjYWxlID1cbiAgICAgICAgKHRleHRhcmVhRG9tLnNjcm9sbEhlaWdodCAtIHRleHRhcmVhRG9tLm9mZnNldEhlaWdodCkgLyAocHJldmlld0RvbS5zY3JvbGxIZWlnaHQgLSBwcmV2aWV3RG9tLm9mZnNldEhlaWdodCk7XG4gICAgICBpZiAoZS50YXJnZXQgPT09IHRleHRhcmVhRG9tICYmIGFjdGl2ZS5jdXJyZW50ID09PSAndGV4dCcpIHtcbiAgICAgICAgcHJldmlld0RvbS5zY3JvbGxUb3AgPSB0ZXh0YXJlYURvbS5zY3JvbGxUb3AgLyBzY2FsZTtcbiAgICAgIH1cbiAgICAgIGlmIChlLnRhcmdldCA9PT0gcHJldmlld0RvbSAmJiBhY3RpdmUuY3VycmVudCA9PT0gJ3ByZXZpZXcnKSB7XG4gICAgICAgIHRleHRhcmVhRG9tLnNjcm9sbFRvcCA9IHByZXZpZXdEb20uc2Nyb2xsVG9wICogc2NhbGU7XG4gICAgICB9XG4gICAgICBsZXQgc2Nyb2xsVG9wID0gMDtcbiAgICAgIGlmIChhY3RpdmUuY3VycmVudCA9PT0gJ3RleHQnKSB7XG4gICAgICAgIHNjcm9sbFRvcCA9IHRleHRhcmVhRG9tLnNjcm9sbFRvcCB8fCAwO1xuICAgICAgfSBlbHNlIGlmIChhY3RpdmUuY3VycmVudCA9PT0gJ3ByZXZpZXcnKSB7XG4gICAgICAgIHNjcm9sbFRvcCA9IHByZXZpZXdEb20uc2Nyb2xsVG9wIHx8IDA7XG4gICAgICB9XG4gICAgICBkaXNwYXRjaCh7IHNjcm9sbFRvcCB9KTtcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIChcbiAgICA8RWRpdG9yQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17eyAuLi5zdGF0ZSwgZGlzcGF0Y2ggfX0+XG4gICAgICA8ZGl2XG4gICAgICAgIHJlZj17Y29udGFpbmVyfVxuICAgICAgICBjbGFzc05hbWU9e2Nsc31cbiAgICAgICAgey4uLm90aGVyfVxuICAgICAgICBvbkNsaWNrPXsoKSA9PiB7XG4gICAgICAgICAgZGlzcGF0Y2goeyBiYXJQb3B1cDogeyAuLi5zZXRHcm91cFBvcEZhbHNlKHN0YXRlLmJhclBvcHVwKSB9IH0pO1xuICAgICAgICB9fVxuICAgICAgICBzdHlsZT17e1xuICAgICAgICAgIC4uLm90aGVyLnN0eWxlLFxuICAgICAgICAgIGhlaWdodDogc3RhdGUuZnVsbHNjcmVlbiA/ICcxMDAlJyA6IGhpZGVUb29sYmFyID8gTnVtYmVyKHN0YXRlLmhlaWdodCkgLSB0b29sYmFySGVpZ2h0IDogc3RhdGUuaGVpZ2h0LFxuICAgICAgICB9fVxuICAgICAgPlxuICAgICAgICB7IWhpZGVUb29sYmFyICYmIDxUb29sYmFyIHByZWZpeENscz17cHJlZml4Q2xzfSBoZWlnaHQ9e3Rvb2xiYXJIZWlnaHR9IC8+fVxuICAgICAgICA8ZGl2XG4gICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LWNvbnRlbnRgfVxuICAgICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgICBoZWlnaHQ6IHN0YXRlLmZ1bGxzY3JlZW4gPyBgY2FsYygxMDAlIC0gJHt0b29sYmFySGVpZ2h0fXB4KWAgOiBOdW1iZXIoc3RhdGUuaGVpZ2h0KSAtIHRvb2xiYXJIZWlnaHQsXG4gICAgICAgICAgfX1cbiAgICAgICAgPlxuICAgICAgICAgIHsvKGVkaXR8bGl2ZSkvLnRlc3Qoc3RhdGUucHJldmlldyB8fCAnJykgJiYgKFxuICAgICAgICAgICAgPFRleHRBcmVhXG4gICAgICAgICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1pbnB1dGB9XG4gICAgICAgICAgICAgIHByZWZpeENscz17cHJlZml4Q2xzfVxuICAgICAgICAgICAgICBhdXRvRm9jdXM9e2F1dG9Gb2N1c31cbiAgICAgICAgICAgICAgey4uLnRleHRhcmVhUHJvcHN9XG4gICAgICAgICAgICAgIHJlbmRlclRleHRhcmVhPXtyZW5kZXJUZXh0YXJlYX1cbiAgICAgICAgICAgICAgb25TY3JvbGw9eyhlKSA9PiBoYW5kbGVTY3JvbGwoZSwgJ3RleHQnKX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKX1cbiAgICAgICAgICB7LyhsaXZlfHByZXZpZXcpLy50ZXN0KHN0YXRlLnByZXZpZXcgfHwgJycpICYmIChcbiAgICAgICAgICAgIDxNYXJrZG93blByZXZpZXdcbiAgICAgICAgICAgICAgey4uLihwcmV2aWV3T3B0aW9ucyBhcyB1bmtub3duKX1cbiAgICAgICAgICAgICAgb25TY3JvbGw9eyhlKSA9PiBoYW5kbGVTY3JvbGwoZSwgJ3ByZXZpZXcnKX1cbiAgICAgICAgICAgICAgcmVmPXtwcmV2aWV3UmVmfVxuICAgICAgICAgICAgICBzb3VyY2U9e3N0YXRlLm1hcmtkb3duIHx8ICcnfVxuICAgICAgICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tcHJldmlld2B9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICl9XG4gICAgICAgIDwvZGl2PlxuICAgICAgICB7dmlzaWFibGVEcmFnYmFyICYmICFzdGF0ZS5mdWxsc2NyZWVuICYmIChcbiAgICAgICAgICA8RHJhZ0JhclxuICAgICAgICAgICAgcHJlZml4Q2xzPXtwcmVmaXhDbHN9XG4gICAgICAgICAgICBoZWlnaHQ9e3N0YXRlLmhlaWdodCBhcyBudW1iZXJ9XG4gICAgICAgICAgICBtYXhIZWlnaHQ9e21heEhlaWdodCF9XG4gICAgICAgICAgICBtaW5IZWlnaHQ9e21pbkhlaWdodCF9XG4gICAgICAgICAgICBvbkNoYW5nZT17KG5ld0hlaWdodCkgPT4ge1xuICAgICAgICAgICAgICBkaXNwYXRjaCh7IGhlaWdodDogbmV3SGVpZ2h0IH0pO1xuICAgICAgICAgICAgfX1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgPC9kaXY+XG4gICAgPC9FZGl0b3JDb250ZXh0LlByb3ZpZGVyPlxuICApO1xufTtcblxuY29uc3QgbWRFZGl0b3IgPSBSZWFjdC5mb3J3YXJkUmVmPENvbnRleHRTdG9yZSwgTURFZGl0b3JQcm9wcz4oSW50ZXJuYWxNREVkaXRvcik7XG5cbnR5cGUgTURFZGl0b3IgPSB0eXBlb2YgbWRFZGl0b3IgJiB7XG4gIE1hcmtkb3duOiB0eXBlb2YgTWFya2Rvd25QcmV2aWV3O1xufTtcblxuKG1kRWRpdG9yIGFzIE1ERWRpdG9yKS5NYXJrZG93biA9IE1hcmtkb3duUHJldmlldztcblxuZXhwb3J0IGRlZmF1bHQgbWRFZGl0b3IgYXMgTURFZGl0b3I7XG4iXX0=