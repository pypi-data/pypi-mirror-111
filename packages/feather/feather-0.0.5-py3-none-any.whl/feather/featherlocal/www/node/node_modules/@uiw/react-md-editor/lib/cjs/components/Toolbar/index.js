"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ToolbarItems = ToolbarItems;
exports.default = Toolbar;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _react = _interopRequireWildcard(require("react"));

var _Context = require("../../Context");

var _Child = _interopRequireDefault(require("./Child"));

function ToolbarItems(props) {
  var prefixCls = props.prefixCls;

  var _useContext = (0, _react.useContext)(_Context.EditorContext),
      fullscreen = _useContext.fullscreen,
      preview = _useContext.preview,
      _useContext$barPopup = _useContext.barPopup,
      barPopup = _useContext$barPopup === void 0 ? {} : _useContext$barPopup,
      commandOrchestrator = _useContext.commandOrchestrator,
      dispatch = _useContext.dispatch;

  function handleClick(command, name) {
    if (!dispatch) return;
    var state = {
      barPopup: (0, _objectSpread2.default)({}, barPopup)
    };

    if (command.keyCommand === 'preview') {
      state.preview = command.value;
    }

    if (command.keyCommand === 'fullscreen') {
      state.fullscreen = !fullscreen;
    }

    if (props.commands && command.keyCommand === 'group') {
      props.commands.forEach(function (item) {
        if (name === item.groupName) {
          state.barPopup[name] = true;
        } else if (item.keyCommand) {
          state.barPopup[item.groupName] = false;
        }
      });
    } else if (name || command.parent) {
      Object.keys(state.barPopup || {}).forEach(function (keyName) {
        state.barPopup[keyName] = false;
      });
    }

    if (Object.keys(state).length) {
      dispatch((0, _objectSpread2.default)({}, state));
    }

    commandOrchestrator && commandOrchestrator.executeCommand(command);
  }

  (0, _react.useEffect)(function () {
    if (document) {
      document.body.style.overflow = !fullscreen ? 'initial' : 'hidden';
    }
  }, [fullscreen]);
  return /*#__PURE__*/_react.default.createElement("ul", null, (props.commands || []).map(function (item, idx) {
    if (item.keyCommand === 'divider') {
      return /*#__PURE__*/_react.default.createElement("li", (0, _extends2.default)({
        key: idx
      }, item.liProps, {
        className: "".concat(prefixCls, "-toolbar-divider")
      }));
    }

    if (!item.keyCommand) return /*#__PURE__*/_react.default.createElement(_react.Fragment, null);
    var activeBtn = fullscreen && item.keyCommand === 'fullscreen' || item.keyCommand === 'preview' && preview === item.value;
    var childNode = item.children && typeof item.children === 'function' ? item.children({
      getState: function getState() {
        return commandOrchestrator.getState();
      },
      textApi: commandOrchestrator ? commandOrchestrator.textApi : undefined,
      close: function close() {
        return handleClick({}, item.groupName);
      },
      execute: function execute() {
        return handleClick({
          execute: item.execute
        });
      }
    }) : undefined;
    var disabled = barPopup && preview && preview === 'preview' && !/(preview|fullscreen)/.test(item.keyCommand);
    return /*#__PURE__*/_react.default.createElement("li", (0, _extends2.default)({
      key: idx
    }, item.liProps, {
      className: activeBtn ? "active" : ''
    }), !item.buttonProps && item.icon, item.buttonProps && /*#__PURE__*/_react.default.createElement('button', (0, _objectSpread2.default)((0, _objectSpread2.default)({
      type: 'button',
      disabled: disabled,
      'data-name': item.name
    }, item.buttonProps), {}, {
      onClick: function onClick(evn) {
        evn.stopPropagation();
        handleClick(item, item.groupName);
      }
    }), item.icon), item.children && /*#__PURE__*/_react.default.createElement(_Child.default, {
      groupName: item.groupName,
      prefixCls: prefixCls,
      children: childNode,
      commands: Array.isArray(item.children) ? item.children : undefined
    }));
  }));
}

function Toolbar() {
  var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var prefixCls = props.prefixCls,
      _props$height = props.height,
      height = _props$height === void 0 ? 29 : _props$height,
      isChild = props.isChild;

  var _useContext2 = (0, _react.useContext)(_Context.EditorContext),
      commands = _useContext2.commands,
      extraCommands = _useContext2.extraCommands;

  return /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-toolbar"),
    style: {
      height: height
    }
  }, /*#__PURE__*/_react.default.createElement(ToolbarItems, (0, _extends2.default)({}, props, {
    commands: props.commands || commands || []
  })), !isChild && /*#__PURE__*/_react.default.createElement(ToolbarItems, (0, _extends2.default)({}, props, {
    commands: extraCommands || []
  })));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1Rvb2xiYXIvaW5kZXgudHN4Il0sIm5hbWVzIjpbIlRvb2xiYXJJdGVtcyIsInByb3BzIiwicHJlZml4Q2xzIiwiRWRpdG9yQ29udGV4dCIsImZ1bGxzY3JlZW4iLCJwcmV2aWV3IiwiYmFyUG9wdXAiLCJjb21tYW5kT3JjaGVzdHJhdG9yIiwiZGlzcGF0Y2giLCJoYW5kbGVDbGljayIsImNvbW1hbmQiLCJuYW1lIiwic3RhdGUiLCJrZXlDb21tYW5kIiwidmFsdWUiLCJjb21tYW5kcyIsImZvckVhY2giLCJpdGVtIiwiZ3JvdXBOYW1lIiwicGFyZW50IiwiT2JqZWN0Iiwia2V5cyIsImtleU5hbWUiLCJsZW5ndGgiLCJleGVjdXRlQ29tbWFuZCIsImRvY3VtZW50IiwiYm9keSIsInN0eWxlIiwib3ZlcmZsb3ciLCJtYXAiLCJpZHgiLCJsaVByb3BzIiwiYWN0aXZlQnRuIiwiY2hpbGROb2RlIiwiY2hpbGRyZW4iLCJnZXRTdGF0ZSIsInRleHRBcGkiLCJ1bmRlZmluZWQiLCJjbG9zZSIsImV4ZWN1dGUiLCJkaXNhYmxlZCIsInRlc3QiLCJidXR0b25Qcm9wcyIsImljb24iLCJSZWFjdCIsImNyZWF0ZUVsZW1lbnQiLCJ0eXBlIiwib25DbGljayIsImV2biIsInN0b3BQcm9wYWdhdGlvbiIsIkFycmF5IiwiaXNBcnJheSIsIlRvb2xiYXIiLCJoZWlnaHQiLCJpc0NoaWxkIiwiZXh0cmFDb21tYW5kcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUVBOztBQVVPLFNBQVNBLFlBQVQsQ0FBc0JDLEtBQXRCLEVBQTRDO0FBQ2pELE1BQVFDLFNBQVIsR0FBc0JELEtBQXRCLENBQVFDLFNBQVI7O0FBQ0Esb0JBQThFLHVCQUFXQyxzQkFBWCxDQUE5RTtBQUFBLE1BQVFDLFVBQVIsZUFBUUEsVUFBUjtBQUFBLE1BQW9CQyxPQUFwQixlQUFvQkEsT0FBcEI7QUFBQSx5Q0FBNkJDLFFBQTdCO0FBQUEsTUFBNkJBLFFBQTdCLHFDQUF3QyxFQUF4QztBQUFBLE1BQTRDQyxtQkFBNUMsZUFBNENBLG1CQUE1QztBQUFBLE1BQWlFQyxRQUFqRSxlQUFpRUEsUUFBakU7O0FBQ0EsV0FBU0MsV0FBVCxDQUFxQkMsT0FBckIsRUFBZ0RDLElBQWhELEVBQStEO0FBQzdELFFBQUksQ0FBQ0gsUUFBTCxFQUFlO0FBQ2YsUUFBTUksS0FBbUIsR0FBRztBQUFFTixNQUFBQSxRQUFRLGtDQUFPQSxRQUFQO0FBQVYsS0FBNUI7O0FBQ0EsUUFBSUksT0FBTyxDQUFDRyxVQUFSLEtBQXVCLFNBQTNCLEVBQXNDO0FBQ3BDRCxNQUFBQSxLQUFLLENBQUNQLE9BQU4sR0FBZ0JLLE9BQU8sQ0FBQ0ksS0FBeEI7QUFDRDs7QUFDRCxRQUFJSixPQUFPLENBQUNHLFVBQVIsS0FBdUIsWUFBM0IsRUFBeUM7QUFDdkNELE1BQUFBLEtBQUssQ0FBQ1IsVUFBTixHQUFtQixDQUFDQSxVQUFwQjtBQUNEOztBQUNELFFBQUlILEtBQUssQ0FBQ2MsUUFBTixJQUFrQkwsT0FBTyxDQUFDRyxVQUFSLEtBQXVCLE9BQTdDLEVBQXNEO0FBQ3BEWixNQUFBQSxLQUFLLENBQUNjLFFBQU4sQ0FBZUMsT0FBZixDQUF1QixVQUFDQyxJQUFELEVBQVU7QUFDL0IsWUFBSU4sSUFBSSxLQUFLTSxJQUFJLENBQUNDLFNBQWxCLEVBQTZCO0FBQzNCTixVQUFBQSxLQUFLLENBQUNOLFFBQU4sQ0FBZ0JLLElBQWhCLElBQXlCLElBQXpCO0FBQ0QsU0FGRCxNQUVPLElBQUlNLElBQUksQ0FBQ0osVUFBVCxFQUFxQjtBQUMxQkQsVUFBQUEsS0FBSyxDQUFDTixRQUFOLENBQWdCVyxJQUFJLENBQUNDLFNBQXJCLElBQW1DLEtBQW5DO0FBQ0Q7QUFDRixPQU5EO0FBT0QsS0FSRCxNQVFPLElBQUlQLElBQUksSUFBSUQsT0FBTyxDQUFDUyxNQUFwQixFQUE0QjtBQUNqQ0MsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVlULEtBQUssQ0FBQ04sUUFBTixJQUFrQixFQUE5QixFQUFrQ1UsT0FBbEMsQ0FBMEMsVUFBQ00sT0FBRCxFQUFhO0FBQ3JEVixRQUFBQSxLQUFLLENBQUNOLFFBQU4sQ0FBZ0JnQixPQUFoQixJQUEyQixLQUEzQjtBQUNELE9BRkQ7QUFHRDs7QUFFRCxRQUFJRixNQUFNLENBQUNDLElBQVAsQ0FBWVQsS0FBWixFQUFtQlcsTUFBdkIsRUFBK0I7QUFDN0JmLE1BQUFBLFFBQVEsaUNBQU1JLEtBQU4sRUFBUjtBQUNEOztBQUNETCxJQUFBQSxtQkFBbUIsSUFBSUEsbUJBQW1CLENBQUNpQixjQUFwQixDQUFtQ2QsT0FBbkMsQ0FBdkI7QUFDRDs7QUFFRCx3QkFBVSxZQUFNO0FBQ2QsUUFBSWUsUUFBSixFQUFjO0FBQ1pBLE1BQUFBLFFBQVEsQ0FBQ0MsSUFBVCxDQUFjQyxLQUFkLENBQW9CQyxRQUFwQixHQUErQixDQUFDeEIsVUFBRCxHQUFjLFNBQWQsR0FBMEIsUUFBekQ7QUFDRDtBQUNGLEdBSkQsRUFJRyxDQUFDQSxVQUFELENBSkg7QUFNQSxzQkFDRSx5Q0FDRyxDQUFDSCxLQUFLLENBQUNjLFFBQU4sSUFBa0IsRUFBbkIsRUFBdUJjLEdBQXZCLENBQTJCLFVBQUNaLElBQUQsRUFBT2EsR0FBUCxFQUFlO0FBQ3pDLFFBQUliLElBQUksQ0FBQ0osVUFBTCxLQUFvQixTQUF4QixFQUFtQztBQUNqQywwQkFBTztBQUFJLFFBQUEsR0FBRyxFQUFFaUI7QUFBVCxTQUFrQmIsSUFBSSxDQUFDYyxPQUF2QjtBQUFnQyxRQUFBLFNBQVMsWUFBSzdCLFNBQUw7QUFBekMsU0FBUDtBQUNEOztBQUNELFFBQUksQ0FBQ2UsSUFBSSxDQUFDSixVQUFWLEVBQXNCLG9CQUFPLDZCQUFDLGVBQUQsT0FBUDtBQUN0QixRQUFNbUIsU0FBUyxHQUNaNUIsVUFBVSxJQUFJYSxJQUFJLENBQUNKLFVBQUwsS0FBb0IsWUFBbkMsSUFBcURJLElBQUksQ0FBQ0osVUFBTCxLQUFvQixTQUFwQixJQUFpQ1IsT0FBTyxLQUFLWSxJQUFJLENBQUNILEtBRHpHO0FBRUEsUUFBTW1CLFNBQVMsR0FDYmhCLElBQUksQ0FBQ2lCLFFBQUwsSUFBaUIsT0FBT2pCLElBQUksQ0FBQ2lCLFFBQVosS0FBeUIsVUFBMUMsR0FDSWpCLElBQUksQ0FBQ2lCLFFBQUwsQ0FBYztBQUNaQyxNQUFBQSxRQUFRLEVBQUU7QUFBQSxlQUFNNUIsbUJBQW1CLENBQUU0QixRQUFyQixFQUFOO0FBQUEsT0FERTtBQUVaQyxNQUFBQSxPQUFPLEVBQUU3QixtQkFBbUIsR0FBR0EsbUJBQW1CLENBQUU2QixPQUF4QixHQUFrQ0MsU0FGbEQ7QUFHWkMsTUFBQUEsS0FBSyxFQUFFO0FBQUEsZUFBTTdCLFdBQVcsQ0FBQyxFQUFELEVBQUtRLElBQUksQ0FBQ0MsU0FBVixDQUFqQjtBQUFBLE9BSEs7QUFJWnFCLE1BQUFBLE9BQU8sRUFBRTtBQUFBLGVBQU05QixXQUFXLENBQUM7QUFBRThCLFVBQUFBLE9BQU8sRUFBRXRCLElBQUksQ0FBQ3NCO0FBQWhCLFNBQUQsQ0FBakI7QUFBQTtBQUpHLEtBQWQsQ0FESixHQU9JRixTQVJOO0FBU0EsUUFBTUcsUUFBUSxHQUFHbEMsUUFBUSxJQUFJRCxPQUFaLElBQXVCQSxPQUFPLEtBQUssU0FBbkMsSUFBZ0QsQ0FBQyx1QkFBdUJvQyxJQUF2QixDQUE0QnhCLElBQUksQ0FBQ0osVUFBakMsQ0FBbEU7QUFDQSx3QkFDRTtBQUFJLE1BQUEsR0FBRyxFQUFFaUI7QUFBVCxPQUFrQmIsSUFBSSxDQUFDYyxPQUF2QjtBQUFnQyxNQUFBLFNBQVMsRUFBRUMsU0FBUyxjQUFjO0FBQWxFLFFBQ0csQ0FBQ2YsSUFBSSxDQUFDeUIsV0FBTixJQUFxQnpCLElBQUksQ0FBQzBCLElBRDdCLEVBRUcxQixJQUFJLENBQUN5QixXQUFMLGlCQUNDRSxlQUFNQyxhQUFOLENBQ0UsUUFERjtBQUdJQyxNQUFBQSxJQUFJLEVBQUUsUUFIVjtBQUlJTixNQUFBQSxRQUFRLEVBQVJBLFFBSko7QUFLSSxtQkFBYXZCLElBQUksQ0FBQ047QUFMdEIsT0FNT00sSUFBSSxDQUFDeUIsV0FOWjtBQU9JSyxNQUFBQSxPQUFPLEVBQUUsaUJBQUNDLEdBQUQsRUFBMEQ7QUFDakVBLFFBQUFBLEdBQUcsQ0FBQ0MsZUFBSjtBQUNBeEMsUUFBQUEsV0FBVyxDQUFDUSxJQUFELEVBQU9BLElBQUksQ0FBQ0MsU0FBWixDQUFYO0FBQ0Q7QUFWTCxRQVlFRCxJQUFJLENBQUMwQixJQVpQLENBSEosRUFpQkcxQixJQUFJLENBQUNpQixRQUFMLGlCQUNDLDZCQUFDLGNBQUQ7QUFDRSxNQUFBLFNBQVMsRUFBRWpCLElBQUksQ0FBQ0MsU0FEbEI7QUFFRSxNQUFBLFNBQVMsRUFBRWhCLFNBRmI7QUFHRSxNQUFBLFFBQVEsRUFBRStCLFNBSFo7QUFJRSxNQUFBLFFBQVEsRUFBRWlCLEtBQUssQ0FBQ0MsT0FBTixDQUFjbEMsSUFBSSxDQUFDaUIsUUFBbkIsSUFBK0JqQixJQUFJLENBQUNpQixRQUFwQyxHQUErQ0c7QUFKM0QsTUFsQkosQ0FERjtBQTRCRCxHQTdDQSxDQURILENBREY7QUFrREQ7O0FBRWMsU0FBU2UsT0FBVCxHQUE0QztBQUFBLE1BQTNCbkQsS0FBMkIsdUVBQUosRUFBSTtBQUN6RCxNQUFRQyxTQUFSLEdBQTRDRCxLQUE1QyxDQUFRQyxTQUFSO0FBQUEsc0JBQTRDRCxLQUE1QyxDQUFtQm9ELE1BQW5CO0FBQUEsTUFBbUJBLE1BQW5CLDhCQUE0QixFQUE1QjtBQUFBLE1BQWdDQyxPQUFoQyxHQUE0Q3JELEtBQTVDLENBQWdDcUQsT0FBaEM7O0FBQ0EscUJBQW9DLHVCQUFXbkQsc0JBQVgsQ0FBcEM7QUFBQSxNQUFRWSxRQUFSLGdCQUFRQSxRQUFSO0FBQUEsTUFBa0J3QyxhQUFsQixnQkFBa0JBLGFBQWxCOztBQUNBLHNCQUNFO0FBQUssSUFBQSxTQUFTLFlBQUtyRCxTQUFMLGFBQWQ7QUFBd0MsSUFBQSxLQUFLLEVBQUU7QUFBRW1ELE1BQUFBLE1BQU0sRUFBTkE7QUFBRjtBQUEvQyxrQkFDRSw2QkFBQyxZQUFELDZCQUFrQnBELEtBQWxCO0FBQXlCLElBQUEsUUFBUSxFQUFFQSxLQUFLLENBQUNjLFFBQU4sSUFBa0JBLFFBQWxCLElBQThCO0FBQWpFLEtBREYsRUFFRyxDQUFDdUMsT0FBRCxpQkFBWSw2QkFBQyxZQUFELDZCQUFrQnJELEtBQWxCO0FBQXlCLElBQUEsUUFBUSxFQUFFc0QsYUFBYSxJQUFJO0FBQXBELEtBRmYsQ0FERjtBQU1EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IEZyYWdtZW50LCB1c2VDb250ZXh0LCB1c2VFZmZlY3QgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBJUHJvcHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBFZGl0b3JDb250ZXh0LCBQcmV2aWV3VHlwZSwgQ29udGV4dFN0b3JlIH0gZnJvbSAnLi4vLi4vQ29udGV4dCc7XG5pbXBvcnQgeyBJQ29tbWFuZCB9IGZyb20gJy4uLy4uL2NvbW1hbmRzJztcbmltcG9ydCBDaGlsZCBmcm9tICcuL0NoaWxkJztcbmltcG9ydCAnLi9pbmRleC5sZXNzJztcblxuZXhwb3J0IGludGVyZmFjZSBJVG9vbGJhclByb3BzIGV4dGVuZHMgSVByb3BzIHtcbiAgaGVpZ2h0PzogUmVhY3QuQ1NTUHJvcGVydGllc1snaGVpZ2h0J107XG4gIG9uQ29tbWFuZD86IChjb21tYW5kOiBJQ29tbWFuZDxzdHJpbmc+LCBncm91cE5hbWU/OiBzdHJpbmcpID0+IHZvaWQ7XG4gIGNvbW1hbmRzPzogSUNvbW1hbmQ8c3RyaW5nPltdO1xuICBpc0NoaWxkPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIFRvb2xiYXJJdGVtcyhwcm9wczogSVRvb2xiYXJQcm9wcykge1xuICBjb25zdCB7IHByZWZpeENscyB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgZnVsbHNjcmVlbiwgcHJldmlldywgYmFyUG9wdXAgPSB7fSwgY29tbWFuZE9yY2hlc3RyYXRvciwgZGlzcGF0Y2ggfSA9IHVzZUNvbnRleHQoRWRpdG9yQ29udGV4dCk7XG4gIGZ1bmN0aW9uIGhhbmRsZUNsaWNrKGNvbW1hbmQ6IElDb21tYW5kPHN0cmluZz4sIG5hbWU/OiBzdHJpbmcpIHtcbiAgICBpZiAoIWRpc3BhdGNoKSByZXR1cm47XG4gICAgY29uc3Qgc3RhdGU6IENvbnRleHRTdG9yZSA9IHsgYmFyUG9wdXA6IHsgLi4uYmFyUG9wdXAgfSB9O1xuICAgIGlmIChjb21tYW5kLmtleUNvbW1hbmQgPT09ICdwcmV2aWV3Jykge1xuICAgICAgc3RhdGUucHJldmlldyA9IGNvbW1hbmQudmFsdWUgYXMgUHJldmlld1R5cGU7XG4gICAgfVxuICAgIGlmIChjb21tYW5kLmtleUNvbW1hbmQgPT09ICdmdWxsc2NyZWVuJykge1xuICAgICAgc3RhdGUuZnVsbHNjcmVlbiA9ICFmdWxsc2NyZWVuO1xuICAgIH1cbiAgICBpZiAocHJvcHMuY29tbWFuZHMgJiYgY29tbWFuZC5rZXlDb21tYW5kID09PSAnZ3JvdXAnKSB7XG4gICAgICBwcm9wcy5jb21tYW5kcy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgIGlmIChuYW1lID09PSBpdGVtLmdyb3VwTmFtZSkge1xuICAgICAgICAgIHN0YXRlLmJhclBvcHVwIVtuYW1lIV0gPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0ua2V5Q29tbWFuZCkge1xuICAgICAgICAgIHN0YXRlLmJhclBvcHVwIVtpdGVtLmdyb3VwTmFtZSFdID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAobmFtZSB8fCBjb21tYW5kLnBhcmVudCkge1xuICAgICAgT2JqZWN0LmtleXMoc3RhdGUuYmFyUG9wdXAgfHwge30pLmZvckVhY2goKGtleU5hbWUpID0+IHtcbiAgICAgICAgc3RhdGUuYmFyUG9wdXAhW2tleU5hbWVdID0gZmFsc2U7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoT2JqZWN0LmtleXMoc3RhdGUpLmxlbmd0aCkge1xuICAgICAgZGlzcGF0Y2goeyAuLi5zdGF0ZSB9KTtcbiAgICB9XG4gICAgY29tbWFuZE9yY2hlc3RyYXRvciAmJiBjb21tYW5kT3JjaGVzdHJhdG9yLmV4ZWN1dGVDb21tYW5kKGNvbW1hbmQpO1xuICB9XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoZG9jdW1lbnQpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSAhZnVsbHNjcmVlbiA/ICdpbml0aWFsJyA6ICdoaWRkZW4nO1xuICAgIH1cbiAgfSwgW2Z1bGxzY3JlZW5dKTtcblxuICByZXR1cm4gKFxuICAgIDx1bD5cbiAgICAgIHsocHJvcHMuY29tbWFuZHMgfHwgW10pLm1hcCgoaXRlbSwgaWR4KSA9PiB7XG4gICAgICAgIGlmIChpdGVtLmtleUNvbW1hbmQgPT09ICdkaXZpZGVyJykge1xuICAgICAgICAgIHJldHVybiA8bGkga2V5PXtpZHh9IHsuLi5pdGVtLmxpUHJvcHN9IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS10b29sYmFyLWRpdmlkZXJgfSAvPjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWl0ZW0ua2V5Q29tbWFuZCkgcmV0dXJuIDxGcmFnbWVudCAvPjtcbiAgICAgICAgY29uc3QgYWN0aXZlQnRuID1cbiAgICAgICAgICAoZnVsbHNjcmVlbiAmJiBpdGVtLmtleUNvbW1hbmQgPT09ICdmdWxsc2NyZWVuJykgfHwgKGl0ZW0ua2V5Q29tbWFuZCA9PT0gJ3ByZXZpZXcnICYmIHByZXZpZXcgPT09IGl0ZW0udmFsdWUpO1xuICAgICAgICBjb25zdCBjaGlsZE5vZGUgPVxuICAgICAgICAgIGl0ZW0uY2hpbGRyZW4gJiYgdHlwZW9mIGl0ZW0uY2hpbGRyZW4gPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgID8gaXRlbS5jaGlsZHJlbih7XG4gICAgICAgICAgICAgICAgZ2V0U3RhdGU6ICgpID0+IGNvbW1hbmRPcmNoZXN0cmF0b3IhLmdldFN0YXRlKCksXG4gICAgICAgICAgICAgICAgdGV4dEFwaTogY29tbWFuZE9yY2hlc3RyYXRvciA/IGNvbW1hbmRPcmNoZXN0cmF0b3IhLnRleHRBcGkgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgY2xvc2U6ICgpID0+IGhhbmRsZUNsaWNrKHt9LCBpdGVtLmdyb3VwTmFtZSksXG4gICAgICAgICAgICAgICAgZXhlY3V0ZTogKCkgPT4gaGFuZGxlQ2xpY2soeyBleGVjdXRlOiBpdGVtLmV4ZWN1dGUgfSksXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgZGlzYWJsZWQgPSBiYXJQb3B1cCAmJiBwcmV2aWV3ICYmIHByZXZpZXcgPT09ICdwcmV2aWV3JyAmJiAhLyhwcmV2aWV3fGZ1bGxzY3JlZW4pLy50ZXN0KGl0ZW0ua2V5Q29tbWFuZCk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgPGxpIGtleT17aWR4fSB7Li4uaXRlbS5saVByb3BzfSBjbGFzc05hbWU9e2FjdGl2ZUJ0biA/IGBhY3RpdmVgIDogJyd9PlxuICAgICAgICAgICAgeyFpdGVtLmJ1dHRvblByb3BzICYmIGl0ZW0uaWNvbn1cbiAgICAgICAgICAgIHtpdGVtLmJ1dHRvblByb3BzICYmXG4gICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXG4gICAgICAgICAgICAgICAgJ2J1dHRvbicsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdHlwZTogJ2J1dHRvbicsXG4gICAgICAgICAgICAgICAgICBkaXNhYmxlZCxcbiAgICAgICAgICAgICAgICAgICdkYXRhLW5hbWUnOiBpdGVtLm5hbWUsXG4gICAgICAgICAgICAgICAgICAuLi5pdGVtLmJ1dHRvblByb3BzLFxuICAgICAgICAgICAgICAgICAgb25DbGljazogKGV2bjogUmVhY3QuTW91c2VFdmVudDxIVE1MQnV0dG9uRWxlbWVudCwgTW91c2VFdmVudD4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXZuLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVDbGljayhpdGVtLCBpdGVtLmdyb3VwTmFtZSk7XG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaXRlbS5pY29uLFxuICAgICAgICAgICAgICApfVxuICAgICAgICAgICAge2l0ZW0uY2hpbGRyZW4gJiYgKFxuICAgICAgICAgICAgICA8Q2hpbGRcbiAgICAgICAgICAgICAgICBncm91cE5hbWU9e2l0ZW0uZ3JvdXBOYW1lfVxuICAgICAgICAgICAgICAgIHByZWZpeENscz17cHJlZml4Q2xzfVxuICAgICAgICAgICAgICAgIGNoaWxkcmVuPXtjaGlsZE5vZGV9XG4gICAgICAgICAgICAgICAgY29tbWFuZHM9e0FycmF5LmlzQXJyYXkoaXRlbS5jaGlsZHJlbikgPyBpdGVtLmNoaWxkcmVuIDogdW5kZWZpbmVkfVxuICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgKX1cbiAgICAgICAgICA8L2xpPlxuICAgICAgICApO1xuICAgICAgfSl9XG4gICAgPC91bD5cbiAgKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gVG9vbGJhcihwcm9wczogSVRvb2xiYXJQcm9wcyA9IHt9KSB7XG4gIGNvbnN0IHsgcHJlZml4Q2xzLCBoZWlnaHQgPSAyOSwgaXNDaGlsZCB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgY29tbWFuZHMsIGV4dHJhQ29tbWFuZHMgfSA9IHVzZUNvbnRleHQoRWRpdG9yQ29udGV4dCk7XG4gIHJldHVybiAoXG4gICAgPGRpdiBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30tdG9vbGJhcmB9IHN0eWxlPXt7IGhlaWdodCB9fT5cbiAgICAgIDxUb29sYmFySXRlbXMgey4uLnByb3BzfSBjb21tYW5kcz17cHJvcHMuY29tbWFuZHMgfHwgY29tbWFuZHMgfHwgW119IC8+XG4gICAgICB7IWlzQ2hpbGQgJiYgPFRvb2xiYXJJdGVtcyB7Li4ucHJvcHN9IGNvbW1hbmRzPXtleHRyYUNvbW1hbmRzIHx8IFtdfSAvPn1cbiAgICA8L2Rpdj5cbiAgKTtcbn1cbiJdfQ==