import insertText from '../../utils/InsertTextAtPosition';
import { TextAreaTextApi } from '../../commands';
import { insertBeforeEachLine } from '../../commands/list';
/**
 * - `13` - `Enter`
 * - `9` - `Tab`
 */

function stopPropagation(e) {
  e.stopPropagation();
  e.preventDefault();
}

export default function handleKeyDown(e) {
  var tabSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 2;
  var target = e.target;
  var starVal = target.value.substr(0, target.selectionStart);
  var valArr = starVal.split('\n');
  var currentLineStr = valArr[valArr.length - 1];
  var textArea = new TextAreaTextApi(target);
  /**
   * `9` - `Tab`
   */

  if (e.code && e.code.toLowerCase() === 'tab') {
    stopPropagation(e);
    var space = new Array(tabSize + 1).join('  ');

    if (target.selectionStart !== target.selectionEnd) {
      var _star = target.value.substring(0, target.selectionStart).split('\n');

      var _end = target.value.substring(0, target.selectionEnd).split('\n');

      var modifiedTextLine = [];

      _end.forEach(function (item, idx) {
        if (item !== _star[idx]) {
          modifiedTextLine.push(item);
        }
      });

      var modifiedText = modifiedTextLine.join('\n');
      var oldSelectText = target.value.substring(target.selectionStart, target.selectionEnd);
      var newStarNum = target.value.substring(0, target.selectionStart).length;
      textArea.setSelectionRange({
        start: target.value.indexOf(modifiedText),
        end: target.selectionEnd
      });
      var modifiedTextObj = insertBeforeEachLine(modifiedText, e.shiftKey ? '' : space);
      var text = modifiedTextObj.modifiedText;

      if (e.shiftKey) {
        text = text.split('\n').map(function (item) {
          return item.replace(new RegExp("^".concat(space)), '');
        }).join('\n');
      }

      textArea.replaceSelection(text);
      var startTabSize = e.shiftKey ? -tabSize : tabSize;
      var endTabSize = e.shiftKey ? -modifiedTextLine.length * tabSize : modifiedTextLine.length * tabSize;
      textArea.setSelectionRange({
        start: newStarNum + startTabSize,
        end: newStarNum + oldSelectText.length + endTabSize
      });
    } else {
      return insertText(target, space);
    }
  } else if (e.code && e.code.toLowerCase() === 'enter' && (/^(-|\*)\s/.test(currentLineStr) || /^\d+.\s/.test(currentLineStr))) {
    /**
     * `13` - `Enter`
     */
    stopPropagation(e);
    var startStr = '\n- ';

    if (currentLineStr.startsWith('*')) {
      startStr = '\n* ';
    }

    if (/^\d+.\s/.test(currentLineStr)) {
      startStr = "\n".concat(parseInt(currentLineStr) + 1, ". ");
    }

    return insertText(target, startStr);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1RleHRBcmVhL2hhbmRsZUtleURvd24udHN4Il0sIm5hbWVzIjpbImluc2VydFRleHQiLCJUZXh0QXJlYVRleHRBcGkiLCJpbnNlcnRCZWZvcmVFYWNoTGluZSIsInN0b3BQcm9wYWdhdGlvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImhhbmRsZUtleURvd24iLCJ0YWJTaXplIiwidGFyZ2V0Iiwic3RhclZhbCIsInZhbHVlIiwic3Vic3RyIiwic2VsZWN0aW9uU3RhcnQiLCJ2YWxBcnIiLCJzcGxpdCIsImN1cnJlbnRMaW5lU3RyIiwibGVuZ3RoIiwidGV4dEFyZWEiLCJjb2RlIiwidG9Mb3dlckNhc2UiLCJzcGFjZSIsIkFycmF5Iiwiam9pbiIsInNlbGVjdGlvbkVuZCIsIl9zdGFyIiwic3Vic3RyaW5nIiwiX2VuZCIsIm1vZGlmaWVkVGV4dExpbmUiLCJmb3JFYWNoIiwiaXRlbSIsImlkeCIsInB1c2giLCJtb2RpZmllZFRleHQiLCJvbGRTZWxlY3RUZXh0IiwibmV3U3Rhck51bSIsInNldFNlbGVjdGlvblJhbmdlIiwic3RhcnQiLCJpbmRleE9mIiwiZW5kIiwibW9kaWZpZWRUZXh0T2JqIiwic2hpZnRLZXkiLCJ0ZXh0IiwibWFwIiwicmVwbGFjZSIsIlJlZ0V4cCIsInJlcGxhY2VTZWxlY3Rpb24iLCJzdGFydFRhYlNpemUiLCJlbmRUYWJTaXplIiwidGVzdCIsInN0YXJ0U3RyIiwic3RhcnRzV2l0aCIsInBhcnNlSW50Il0sIm1hcHBpbmdzIjoiQUFBQSxPQUFPQSxVQUFQLE1BQXVCLGtDQUF2QjtBQUNBLFNBQVNDLGVBQVQsUUFBZ0MsZ0JBQWhDO0FBQ0EsU0FBU0Msb0JBQVQsUUFBcUMscUJBQXJDO0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBQ0EsU0FBU0MsZUFBVCxDQUF5QkMsQ0FBekIsRUFBc0Y7QUFDcEZBLEVBQUFBLENBQUMsQ0FBQ0QsZUFBRjtBQUNBQyxFQUFBQSxDQUFDLENBQUNDLGNB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QUNsQ2tDLE1BQUFBLFFBQVEsZUFBUUUsUUFBUSxDQUFDcEMsY0FBRCxDQUFSLEdBQTJCLENBQW5DLE9BQVI7QUFDRDs7QUFDRCxXQUFPZixVQUFVLENBQUNRLE1BQUQsRUFBU3lDLFFBQVQsQ0FBakI7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGluc2VydFRleHQgZnJvbSAnLi4vLi4vdXRpbHMvSW5zZXJ0VGV4dEF0UG9zaXRpb24nO1xuaW1wb3J0IHsgVGV4dEFyZWFUZXh0QXBpIH0gZnJvbSAnLi4vLi4vY29tbWFuZHMnO1xuaW1wb3J0IHsgaW5zZXJ0QmVmb3JlRWFjaExpbmUgfSBmcm9tICcuLi8uLi9jb21tYW5kcy9saXN0JztcblxuLyoqXG4gKiAtIGAxM2AgLSBgRW50ZXJgXG4gKiAtIGA5YCAtIGBUYWJgXG4gKi9cbmZ1bmN0aW9uIHN0b3BQcm9wYWdhdGlvbihlOiBLZXlib2FyZEV2ZW50IHwgUmVhY3QuS2V5Ym9hcmRFdmVudDxIVE1MVGV4dEFyZWFFbGVtZW50Pikge1xuICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICBlLnByZXZlbnREZWZhdWx0KCk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGhhbmRsZUtleURvd24oXG4gIGU6IEtleWJvYXJkRXZlbnQgfCBSZWFjdC5LZXlib2FyZEV2ZW50PEhUTUxUZXh0QXJlYUVsZW1lbnQ+LFxuICB0YWJTaXplOiBudW1iZXIgPSAyLFxuKSB7XG4gIGNvbnN0IHRhcmdldCA9IGUudGFyZ2V0IGFzIEhUTUxUZXh0QXJlYUVsZW1lbnQ7XG4gIGNvbnN0IHN0YXJWYWwgPSB0YXJnZXQudmFsdWUuc3Vic3RyKDAsIHRhcmdldC5zZWxlY3Rpb25TdGFydCk7XG4gIGNvbnN0IHZhbEFyciA9IHN0YXJWYWwuc3BsaXQoJ1xcbicpO1xuICBjb25zdCBjdXJyZW50TGluZVN0ciA9IHZhbEFyclt2YWxBcnIubGVuZ3RoIC0gMV07XG4gIGNvbnN0IHRleHRBcmVhID0gbmV3IFRleHRBcmVhVGV4dEFwaSh0YXJnZXQpO1xuICAvKipcbiAgICogYDlgIC0gYFRhYmBcbiAgICovXG4gIGlmIChlLmNvZGUgJiYgZS5jb2RlLnRvTG93ZXJDYXNlKCkgPT09ICd0YWInKSB7XG4gICAgc3RvcFByb3BhZ2F0aW9uKGUpO1xuICAgIGNvbnN0IHNwYWNlID0gbmV3IEFycmF5KHRhYlNpemUgKyAxKS5qb2luKCcgICcpO1xuICAgIGlmICh0YXJnZXQuc2VsZWN0aW9uU3RhcnQgIT09IHRhcmdldC5zZWxlY3Rpb25FbmQpIHtcbiAgICAgIGNvbnN0IF9zdGFyID0gdGFyZ2V0LnZhbHVlLnN1YnN0cmluZygwLCB0YXJnZXQuc2VsZWN0aW9uU3RhcnQpLnNwbGl0KCdcXG4nKTtcbiAgICAgIGNvbnN0IF9lbmQgPSB0YXJnZXQudmFsdWUuc3Vic3RyaW5nKDAsIHRhcmdldC5zZWxlY3Rpb25FbmQpLnNwbGl0KCdcXG4nKTtcbiAgICAgIGNvbnN0IG1vZGlmaWVkVGV4dExpbmU6IHN0cmluZ1tdID0gW107XG4gICAgICBfZW5kLmZvckVhY2goKGl0ZW0sIGlkeCkgPT4ge1xuICAgICAgICBpZiAoaXRlbSAhPT0gX3N0YXJbaWR4XSkge1xuICAgICAgICAgIG1vZGlmaWVkVGV4dExpbmUucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBtb2RpZmllZFRleHQgPSBtb2RpZmllZFRleHRMaW5lLmpvaW4oJ1xcbicpO1xuICAgICAgY29uc3Qgb2xkU2VsZWN0VGV4dCA9IHRhcmdldC52YWx1ZS5zdWJzdHJpbmcodGFyZ2V0LnNlbGVjdGlvblN0YXJ0LCB0YXJnZXQuc2VsZWN0aW9uRW5kKTtcbiAgICAgIGNvbnN0IG5ld1N0YXJOdW0gPSB0YXJnZXQudmFsdWUuc3Vic3RyaW5nKDAsIHRhcmdldC5zZWxlY3Rpb25TdGFydCkubGVuZ3RoO1xuXG4gICAgICB0ZXh0QXJlYS5zZXRTZWxlY3Rpb25SYW5nZSh7XG4gICAgICAgIHN0YXJ0OiB0YXJnZXQudmFsdWUuaW5kZXhPZihtb2RpZmllZFRleHQpLFxuICAgICAgICBlbmQ6IHRhcmdldC5zZWxlY3Rpb25FbmQsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgbW9kaWZpZWRUZXh0T2JqID0gaW5zZXJ0QmVmb3JlRWFjaExpbmUobW9kaWZpZWRUZXh0LCBlLnNoaWZ0S2V5ID8gJycgOiBzcGFjZSk7XG5cbiAgICAgIGxldCB0ZXh0ID0gbW9kaWZpZWRUZXh0T2JqLm1vZGlmaWVkVGV4dDtcbiAgICAgIGlmIChlLnNoaWZ0S2V5KSB7XG4gICAgICAgIHRleHQgPSB0ZXh0XG4gICAgICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgICAgIC5tYXAoKGl0ZW0pID0+IGl0ZW0ucmVwbGFjZShuZXcgUmVnRXhwKGBeJHtzcGFjZX1gKSwgJycpKVxuICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgIH1cbiAgICAgIHRleHRBcmVhLnJlcGxhY2VTZWxlY3Rpb24odGV4dCk7XG5cbiAgICAgIGxldCBzdGFydFRhYlNpemUgPSBlLnNoaWZ0S2V5ID8gLXRhYlNpemUgOiB0YWJTaXplO1xuICAgICAgbGV0IGVuZFRhYlNpemUgPSBlLnNoaWZ0S2V5ID8gLW1vZGlmaWVkVGV4dExpbmUubGVuZ3RoICogdGFiU2l6ZSA6IG1vZGlmaWVkVGV4dExpbmUubGVuZ3RoICogdGFiU2l6ZTtcblxuICAgICAgdGV4dEFyZWEuc2V0U2VsZWN0aW9uUmFuZ2Uoe1xuICAgICAgICBzdGFydDogbmV3U3Rhck51bSArIHN0YXJ0VGFiU2l6ZSxcbiAgICAgICAgZW5kOiBuZXdTdGFyTnVtICsgb2xkU2VsZWN0VGV4dC5sZW5ndGggKyBlbmRUYWJTaXplLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBpbnNlcnRUZXh0KHRhcmdldCwgc3BhY2UpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChcbiAgICBlLmNvZGUgJiZcbiAgICBlLmNvZGUudG9Mb3dlckNhc2UoKSA9PT0gJ2VudGVyJyAmJlxuICAgICgvXigtfFxcKilcXHMvLnRlc3QoY3VycmVudExpbmVTdHIpIHx8IC9eXFxkKy5cXHMvLnRlc3QoY3VycmVudExpbmVTdHIpKVxuICApIHtcbiAgICAvKipcbiAgICAgKiBgMTNgIC0gYEVudGVyYFxuICAgICAqL1xuICAgIHN0b3BQcm9wYWdhdGlvbihlKTtcbiAgICBsZXQgc3RhcnRTdHIgPSAnXFxuLSAnO1xuICAgIGlmIChjdXJyZW50TGluZVN0ci5zdGFydHNXaXRoKCcqJykpIHtcbiAgICAgIHN0YXJ0U3RyID0gJ1xcbiogJztcbiAgICB9XG4gICAgaWYgKC9eXFxkKy5cXHMvLnRlc3QoY3VycmVudExpbmVTdHIpKSB7XG4gICAgICBzdGFydFN0ciA9IGBcXG4ke3BhcnNlSW50KGN1cnJlbnRMaW5lU3RyKSArIDF9LiBgO1xuICAgIH1cbiAgICByZXR1cm4gaW5zZXJ0VGV4dCh0YXJnZXQsIHN0YXJ0U3RyKTtcbiAgfVxufVxuIl19