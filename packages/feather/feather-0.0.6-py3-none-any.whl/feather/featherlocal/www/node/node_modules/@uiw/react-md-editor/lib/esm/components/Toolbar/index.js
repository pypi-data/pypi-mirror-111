import _extends from "@babel/runtime/helpers/extends";
import _objectSpread from "@babel/runtime/helpers/objectSpread2";
import React, { Fragment, useContext, useEffect } from 'react';
import { EditorContext } from '../../Context';
import Child from './Child';
import "./index.css";
export function ToolbarItems(props) {
  var prefixCls = props.prefixCls;

  var _useContext = useContext(EditorContext),
      fullscreen = _useContext.fullscreen,
      preview = _useContext.preview,
      _useContext$barPopup = _useContext.barPopup,
      barPopup = _useContext$barPopup === void 0 ? {} : _useContext$barPopup,
      commandOrchestrator = _useContext.commandOrchestrator,
      dispatch = _useContext.dispatch;

  function handleClick(command, name) {
    if (!dispatch) return;
    var state = {
      barPopup: _objectSpread({}, barPopup)
    };

    if (command.keyCommand === 'preview') {
      state.preview = command.value;
    }

    if (command.keyCommand === 'fullscreen') {
      state.fullscreen = !fullscreen;
    }

    if (props.commands && command.keyCommand === 'group') {
      props.commands.forEach(function (item) {
        if (name === item.groupName) {
          state.barPopup[name] = true;
        } else if (item.keyCommand) {
          state.barPopup[item.groupName] = false;
        }
      });
    } else if (name || command.parent) {
      Object.keys(state.barPopup || {}).forEach(function (keyName) {
        state.barPopup[keyName] = false;
      });
    }

    if (Object.keys(state).length) {
      dispatch(_objectSpread({}, state));
    }

    commandOrchestrator && commandOrchestrator.executeCommand(command);
  }

  useEffect(function () {
    if (document) {
      document.body.style.overflow = !fullscreen ? 'initial' : 'hidden';
    }
  }, [fullscreen]);
  return /*#__PURE__*/React.createElement("ul", null, (props.commands || []).map(function (item, idx) {
    if (item.keyCommand === 'divider') {
      return /*#__PURE__*/React.createElement("li", _extends({
        key: idx
      }, item.liProps, {
        className: "".concat(prefixCls, "-toolbar-divider")
      }));
    }

    if (!item.keyCommand) return /*#__PURE__*/React.createElement(Fragment, null);
    var activeBtn = fullscreen && item.keyCommand === 'fullscreen' || item.keyCommand === 'preview' && preview === item.value;
    var childNode = item.children && typeof item.children === 'function' ? item.children({
      getState: function getState() {
        return commandOrchestrator.getState();
      },
      textApi: commandOrchestrator ? commandOrchestrator.textApi : undefined,
      close: function close() {
        return handleClick({}, item.groupName);
      },
      execute: function execute() {
        return handleClick({
          execute: item.execute
        });
      }
    }) : undefined;
    var disabled = barPopup && preview && preview === 'preview' && !/(preview|fullscreen)/.test(item.keyCommand);
    return /*#__PURE__*/React.createElement("li", _extends({
      key: idx
    }, item.liProps, {
      className: activeBtn ? "active" : ''
    }), !item.buttonProps && item.icon, item.buttonProps && /*#__PURE__*/React.createElement('button', _objectSpread(_objectSpread({
      type: 'button',
      disabled: disabled,
      'data-name': item.name
    }, item.buttonProps), {}, {
      onClick: function onClick(evn) {
        evn.stopPropagation();
        handleClick(item, item.groupName);
      }
    }), item.icon), item.children && /*#__PURE__*/React.createElement(Child, {
      groupName: item.groupName,
      prefixCls: prefixCls,
      children: childNode,
      commands: Array.isArray(item.children) ? item.children : undefined
    }));
  }));
}
export default function Toolbar() {
  var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var prefixCls = props.prefixCls,
      _props$height = props.height,
      height = _props$height === void 0 ? 29 : _props$height,
      isChild = props.isChild;

  var _useContext2 = useContext(EditorContext),
      commands = _useContext2.commands,
      extraCommands = _useContext2.extraCommands;

  return /*#__PURE__*/React.createElement("div", {
    className: "".concat(prefixCls, "-toolbar"),
    style: {
      height: height
    }
  }, /*#__PURE__*/React.createElement(ToolbarItems, _extends({}, props, {
    commands: props.commands || commands || []
  })), !isChild && /*#__PURE__*/React.createElement(ToolbarItems, _extends({}, props, {
    commands: extraCommands || []
  })));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1Rvb2xiYXIvaW5kZXgudHN4Il0sIm5hbWVzIjpbIlJlYWN0IiwiRnJhZ21lbnQiLCJ1c2VDb250ZXh0IiwidXNlRWZmZWN0IiwiRWRpdG9yQ29udGV4dCIsIkNoaWxkIiwiVG9vbGJhckl0ZW1zIiwicHJvcHMiLCJwcmVmaXhDbHMiLCJmdWxsc2NyZWVuIiwicHJldmlldyIsImJhclBvcHVwIiwiY29tbWFuZE9yY2hlc3RyYXRvciIsImRpc3BhdGNoIiwiaGFuZGxlQ2xpY2siLCJjb21tYW5kIiwibmFtZSIsInN0YXRlIiwia2V5Q29tbWFuZCIsInZhbHVlIiwiY29tbWFuZHMiLCJmb3JFYWNoIiwiaXRlbSIsImdyb3VwTmFtZSIsInBhcmVudCIsIk9iamVjdCIsImtleXMiLCJrZXlOYW1lIiwibGVuZ3RoIiwiZXhlY3V0ZUNvbW1hbmQiLCJkb2N1bWVudCIsImJvZHkiLCJzdHlsZSIsIm92ZXJmbG93IiwibWFwIiwiaWR4IiwibGlQcm9wcyIsImFjdGl2ZUJ0biIsImNoaWxkTm9kZSIsImNoaWxkcmVuIiwiZ2V0U3RhdGUiLCJ0ZXh0QXBpIiwidW5kZWZpbmVkIiwiY2xvc2UiLCJleGVjdXRlIiwiZGlzYWJsZWQiLCJ0ZXN0IiwiYnV0dG9uUHJvcHMiLCJpY29uIiwiY3JlYXRlRWxlbWVudCIsInR5cGUiLCJvbkNsaWNrIiwiZXZuIiwic3RvcFByb3BhZ2F0aW9uIiwiQXJyYXkiLCJpc0FycmF5IiwiVG9vbGJhciIsImhlaWdodCIsImlzQ2hpbGQiLCJleHRyYUNvbW1hbmRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU9BLEtBQVAsSUFBZ0JDLFFBQWhCLEVBQTBCQyxVQUExQixFQUFzQ0MsU0FBdEMsUUFBdUQsT0FBdkQ7QUFFQSxTQUFTQyxhQUFULFFBQXlELGVBQXpEO0FBRUEsT0FBT0MsS0FBUCxNQUFrQixTQUFsQjtBQUNBO0FBU0EsT0FBTyxTQUFTQyxZQUFULENBQXNCQyxLQUF0QixFQUE0QztB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Z0JBQWtCQSxhQUFsQjs7QUFDQSxzQkFDRTtBQUFLLElBQUEsU0FBUyxZQUFLbkQsU0FBTCxhQUFkO0FBQXdDLElBQUEsS0FBSyxFQUFFO0FBQUVpRCxNQUFBQSxNQUFNLEVBQU5BO0FBQUY7QUFBL0Msa0JBQ0Usb0JBQUMsWUFBRCxlQUFrQmxELEtBQWxCO0FBQXlCLElBQUEsUUFBUSxFQUFFQSxLQUFLLENBQUNhLFFBQU4sSUFBa0JBLFFBQWxCLElBQThCO0FBQWpFLEtBREYsRUFFRyxDQUFDc0MsT0FBRCxpQkFBWSxvQkFBQyxZQUFELGVBQWtCbkQsS0FBbEI7QUFBeUIsSUFBQSxRQUFRLEVBQUVvRCxhQUFhLElBQUk7QUFBcEQsS0FGZixDQURGO0FBTUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgRnJhZ21lbnQsIHVzZUNvbnRleHQsIHVzZUVmZmVjdCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IElQcm9wcyB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IEVkaXRvckNvbnRleHQsIFByZXZpZXdUeXBlLCBDb250ZXh0U3RvcmUgfSBmcm9tICcuLi8uLi9Db250ZXh0JztcbmltcG9ydCB7IElDb21tYW5kIH0gZnJvbSAnLi4vLi4vY29tbWFuZHMnO1xuaW1wb3J0IENoaWxkIGZyb20gJy4vQ2hpbGQnO1xuaW1wb3J0ICcuL2luZGV4Lmxlc3MnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElUb29sYmFyUHJvcHMgZXh0ZW5kcyBJUHJvcHMge1xuICBoZWlnaHQ/OiBSZWFjdC5DU1NQcm9wZXJ0aWVzWydoZWlnaHQnXTtcbiAgb25Db21tYW5kPzogKGNvbW1hbmQ6IElDb21tYW5kPHN0cmluZz4sIGdyb3VwTmFtZT86IHN0cmluZykgPT4gdm9pZDtcbiAgY29tbWFuZHM/OiBJQ29tbWFuZDxzdHJpbmc+W107XG4gIGlzQ2hpbGQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gVG9vbGJhckl0ZW1zKHByb3BzOiBJVG9vbGJhclByb3BzKSB7XG4gIGNvbnN0IHsgcHJlZml4Q2xzIH0gPSBwcm9wcztcbiAgY29uc3QgeyBmdWxsc2NyZWVuLCBwcmV2aWV3LCBiYXJQb3B1cCA9IHt9LCBjb21tYW5kT3JjaGVzdHJhdG9yLCBkaXNwYXRjaCB9ID0gdXNlQ29udGV4dChFZGl0b3JDb250ZXh0KTtcbiAgZnVuY3Rpb24gaGFuZGxlQ2xpY2soY29tbWFuZDogSUNvbW1hbmQ8c3RyaW5nPiwgbmFtZT86IHN0cmluZykge1xuICAgIGlmICghZGlzcGF0Y2gpIHJldHVybjtcbiAgICBjb25zdCBzdGF0ZTogQ29udGV4dFN0b3JlID0geyBiYXJQb3B1cDogeyAuLi5iYXJQb3B1cCB9IH07XG4gICAgaWYgKGNvbW1hbmQua2V5Q29tbWFuZCA9PT0gJ3ByZXZpZXcnKSB7XG4gICAgICBzdGF0ZS5wcmV2aWV3ID0gY29tbWFuZC52YWx1ZSBhcyBQcmV2aWV3VHlwZTtcbiAgICB9XG4gICAgaWYgKGNvbW1hbmQua2V5Q29tbWFuZCA9PT0gJ2Z1bGxzY3JlZW4nKSB7XG4gICAgICBzdGF0ZS5mdWxsc2NyZWVuID0gIWZ1bGxzY3JlZW47XG4gICAgfVxuICAgIGlmIChwcm9wcy5jb21tYW5kcyAmJiBjb21tYW5kLmtleUNvbW1hbmQgPT09ICdncm91cCcpIHtcbiAgICAgIHByb3BzLmNvbW1hbmRzLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKG5hbWUgPT09IGl0ZW0uZ3JvdXBOYW1lKSB7XG4gICAgICAgICAgc3RhdGUuYmFyUG9wdXAhW25hbWUhXSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbS5rZXlDb21tYW5kKSB7XG4gICAgICAgICAgc3RhdGUuYmFyUG9wdXAhW2l0ZW0uZ3JvdXBOYW1lIV0gPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChuYW1lIHx8IGNvbW1hbmQucGFyZW50KSB7XG4gICAgICBPYmplY3Qua2V5cyhzdGF0ZS5iYXJQb3B1cCB8fCB7fSkuZm9yRWFjaCgoa2V5TmFtZSkgPT4ge1xuICAgICAgICBzdGF0ZS5iYXJQb3B1cCFba2V5TmFtZV0gPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChPYmplY3Qua2V5cyhzdGF0ZSkubGVuZ3RoKSB7XG4gICAgICBkaXNwYXRjaCh7IC4uLnN0YXRlIH0pO1xuICAgIH1cbiAgICBjb21tYW5kT3JjaGVzdHJhdG9yICYmIGNvbW1hbmRPcmNoZXN0cmF0b3IuZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCk7XG4gIH1cblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChkb2N1bWVudCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdyA9ICFmdWxsc2NyZWVuID8gJ2luaXRpYWwnIDogJ2hpZGRlbic7XG4gICAgfVxuICB9LCBbZnVsbHNjcmVlbl0pO1xuXG4gIHJldHVybiAoXG4gICAgPHVsPlxuICAgICAgeyhwcm9wcy5jb21tYW5kcyB8fCBbXSkubWFwKChpdGVtLCBpZHgpID0+IHtcbiAgICAgICAgaWYgKGl0ZW0ua2V5Q29tbWFuZCA9PT0gJ2RpdmlkZXInKSB7XG4gICAgICAgICAgcmV0dXJuIDxsaSBrZXk9e2lkeH0gey4uLml0ZW0ubGlQcm9wc30gY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LXRvb2xiYXItZGl2aWRlcmB9IC8+O1xuICAgICAgICB9XG4gICAgICAgIGlmICghaXRlbS5rZXlDb21tYW5kKSByZXR1cm4gPEZyYWdtZW50IC8+O1xuICAgICAgICBjb25zdCBhY3RpdmVCdG4gPVxuICAgICAgICAgIChmdWxsc2NyZWVuICYmIGl0ZW0ua2V5Q29tbWFuZCA9PT0gJ2Z1bGxzY3JlZW4nKSB8fCAoaXRlbS5rZXlDb21tYW5kID09PSAncHJldmlldycgJiYgcHJldmlldyA9PT0gaXRlbS52YWx1ZSk7XG4gICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9XG4gICAgICAgICAgaXRlbS5jaGlsZHJlbiAmJiB0eXBlb2YgaXRlbS5jaGlsZHJlbiA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICAgPyBpdGVtLmNoaWxkcmVuKHtcbiAgICAgICAgICAgICAgICBnZXRTdGF0ZTogKCkgPT4gY29tbWFuZE9yY2hlc3RyYXRvciEuZ2V0U3RhdGUoKSxcbiAgICAgICAgICAgICAgICB0ZXh0QXBpOiBjb21tYW5kT3JjaGVzdHJhdG9yID8gY29tbWFuZE9yY2hlc3RyYXRvciEudGV4dEFwaSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBjbG9zZTogKCkgPT4gaGFuZGxlQ2xpY2soe30sIGl0ZW0uZ3JvdXBOYW1lKSxcbiAgICAgICAgICAgICAgICBleGVjdXRlOiAoKSA9PiBoYW5kbGVDbGljayh7IGV4ZWN1dGU6IGl0ZW0uZXhlY3V0ZSB9KSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICBjb25zdCBkaXNhYmxlZCA9IGJhclBvcHVwICYmIHByZXZpZXcgJiYgcHJldmlldyA9PT0gJ3ByZXZpZXcnICYmICEvKHByZXZpZXd8ZnVsbHNjcmVlbikvLnRlc3QoaXRlbS5rZXlDb21tYW5kKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8bGkga2V5PXtpZHh9IHsuLi5pdGVtLmxpUHJvcHN9IGNsYXNzTmFtZT17YWN0aXZlQnRuID8gYGFjdGl2ZWAgOiAnJ30+XG4gICAgICAgICAgICB7IWl0ZW0uYnV0dG9uUHJvcHMgJiYgaXRlbS5pY29ufVxuICAgICAgICAgICAge2l0ZW0uYnV0dG9uUHJvcHMgJiZcbiAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChcbiAgICAgICAgICAgICAgICAnYnV0dG9uJyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICB0eXBlOiAnYnV0dG9uJyxcbiAgICAgICAgICAgICAgICAgIGRpc2FibGVkLFxuICAgICAgICAgICAgICAgICAgJ2RhdGEtbmFtZSc6IGl0ZW0ubmFtZSxcbiAgICAgICAgICAgICAgICAgIC4uLml0ZW0uYnV0dG9uUHJvcHMsXG4gICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoZXZuOiBSZWFjdC5Nb3VzZUV2ZW50PEhUTUxCdXR0b25FbGVtZW50LCBNb3VzZUV2ZW50PikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldm4uc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZUNsaWNrKGl0ZW0sIGl0ZW0uZ3JvdXBOYW1lKTtcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBpdGVtLmljb24sXG4gICAgICAgICAgICAgICl9XG4gICAgICAgICAgICB7aXRlbS5jaGlsZHJlbiAmJiAoXG4gICAgICAgICAgICAgIDxDaGlsZFxuICAgICAgICAgICAgICAgIGdyb3VwTmFtZT17aXRlbS5ncm91cE5hbWV9XG4gICAgICAgICAgICAgICAgcHJlZml4Q2xzPXtwcmVmaXhDbHN9XG4gICAgICAgICAgICAgICAgY2hpbGRyZW49e2NoaWxkTm9kZX1cbiAgICAgICAgICAgICAgICBjb21tYW5kcz17QXJyYXkuaXNBcnJheShpdGVtLmNoaWxkcmVuKSA/IGl0ZW0uY2hpbGRyZW4gOiB1bmRlZmluZWR9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApfVxuICAgICAgICAgIDwvbGk+XG4gICAgICAgICk7XG4gICAgICB9KX1cbiAgICA8L3VsPlxuICApO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBUb29sYmFyKHByb3BzOiBJVG9vbGJhclByb3BzID0ge30pIHtcbiAgY29uc3QgeyBwcmVmaXhDbHMsIGhlaWdodCA9IDI5LCBpc0NoaWxkIH0gPSBwcm9wcztcbiAgY29uc3QgeyBjb21tYW5kcywgZXh0cmFDb21tYW5kcyB9ID0gdXNlQ29udGV4dChFZGl0b3JDb250ZXh0KTtcbiAgcmV0dXJuIChcbiAgICA8ZGl2IGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS10b29sYmFyYH0gc3R5bGU9e3sgaGVpZ2h0IH19PlxuICAgICAgPFRvb2xiYXJJdGVtcyB7Li4ucHJvcHN9IGNvbW1hbmRzPXtwcm9wcy5jb21tYW5kcyB8fCBjb21tYW5kcyB8fCBbXX0gLz5cbiAgICAgIHshaXNDaGlsZCAmJiA8VG9vbGJhckl0ZW1zIHsuLi5wcm9wc30gY29tbWFuZHM9e2V4dHJhQ29tbWFuZHMgfHwgW119IC8+fVxuICAgIDwvZGl2PlxuICApO1xufVxuIl19