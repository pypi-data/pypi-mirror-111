import _extends from "@babel/runtime/helpers/extends";
import _objectSpread from "@babel/runtime/helpers/objectSpread2";
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";
var _excluded = ["prefixCls", "className", "value", "commands", "extraCommands", "height", "toolbarHeight", "enableScroll", "visiableDragbar", "highlightEnable", "preview", "fullscreen", "previewOptions", "textareaProps", "maxHeight", "minHeight", "autoFocus", "tabSize", "onChange", "hideToolbar", "renderTextarea"];
import React, { useEffect, useReducer, useMemo, useRef, useImperativeHandle } from 'react';
import MarkdownPreview from '@uiw/react-markdown-preview';
import TextArea from './components/TextArea';
import Toolbar from './components/Toolbar';
import DragBar from './components/DragBar';
import { getCommands, getExtraCommands } from './commands';
import { reducer, EditorContext } from './Context';
import "./index.css";

function setGroupPopFalse() {
  var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  Object.keys(data).forEach(function (keyname) {
    data[keyname] = false;
  });
  return data;
}

var InternalMDEditor = function InternalMDEditor(props, ref) {
  var _ref = props || {},
      _ref$prefixCls = _ref.prefixCls,
      prefixCls = _ref$prefixCls === void 0 ? 'w-md-editor' : _ref$prefixCls,
      className = _ref.className,
      propsValue = _ref.value,
      _ref$commands = _ref.commands,
      commands = _ref$commands === void 0 ? getCommands() : _ref$commands,
      _ref$extraCommands = _ref.extraCommands,
      extraCommands = _ref$extraCommands === void 0 ? getExtraCommands() : _ref$extraCommands,
      _ref$height = _ref.height,
      height = _ref$height === void 0 ? 200 : _ref$height,
      _ref$toolbarHeight = _ref.toolbarHeight,
      toolbarHeight = _ref$toolbarHeight === void 0 ? 29 : _ref$toolbarHeight,
      _ref$enableScroll = _ref.enableScroll,
      enableScroll = _ref$enableScroll === void 0 ? true : _ref$enableScroll,
      _ref$visiableDragbar = _ref.visiableDragbar,
      visiableDragbar = _ref$visiableDragbar === void 0 ? true : _ref$visiableDragbar,
      _ref$highlightEnable = _ref.highlightEnable,
      highlightEnable = _ref$highlightEnable === void 0 ? true : _ref$highlightEnable,
      _ref$preview = _ref.preview,
      previewType = _ref$preview === void 0 ? 'live' : _ref$preview,
      _ref$fullscreen = _ref.fullscreen,
      fullscreen = _ref$fullscreen === void 0 ? false : _ref$fullscreen,
      _ref$previewOptions = _ref.previewOptions,
      previewOptions = _ref$previewOptions === void 0 ? {} : _ref$previewOptions,
      textareaProps = _ref.textareaProps,
      _ref$maxHeight = _ref.maxHeight,
      maxHeight = _ref$maxHeight === void 0 ? 1200 : _ref$maxHeight,
      _ref$minHeight = _ref.minHeight,
      minHeight = _ref$minHeight === void 0 ? 100 : _ref$minHeight,
      autoFocus = _ref.autoFocus,
      _ref$tabSize = _ref.tabSize,
      tabSize = _ref$tabSize === void 0 ? 2 : _ref$tabSize,
      onChange = _ref.onChange,
      hideToolbar = _ref.hideToolbar,
      renderTextarea = _ref.renderTextarea,
      other = _objectWithoutProperties(_ref, _excluded);

  var _useReducer = useReducer(reducer, {
    markdown: propsValue,
    preview: previewType,
    height: height,
    highlightEnable: highlightEnable,
    tabSize: tabSize,
    scrollTop: 0,
    scrollTopPreview: 0,
    commands: commands,
    extraCommands: extraCommands,
    fullscreen: fullscreen,
    onChange: onChange,
    barPopup: {}
  }),
      _useReducer2 = _slicedToArray(_useReducer, 2),
      state = _useReducer2[0],
      dispatch = _useReducer2[1];

  var container = useRef(null);
  var previewRef = useRef(null);
  var enableScrollRef = useRef(enableScroll);
  useImperativeHandle(ref, function () {
    return _objectSpread({}, state);
  });
  useMemo(function () {
    return enableScrollRef.current = enableScroll;
  }, [enableScroll]);
  useEffect(function () {
    var stateInit = {};

    if (container.current) {
      stateInit.container = container.current || undefined;
    }

    stateInit.markdown = propsValue || '';
    stateInit.barPopup = {};

    if (dispatch) {
      dispatch(_objectSpread(_objectSpread({}, state), stateInit));
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var cls = [className, prefixCls, state.preview ? "".concat(prefixCls, "-show-").concat(state.preview) : null, state.fullscreen ? "".concat(prefixCls, "-fullscreen") : null].filter(Boolean).join(' ').trim();
  useMemo(function () {
    return propsValue !== state.markdown && dispatch({
      markdown: propsValue || ''
    });
  }, [propsValue, state.markdown]); // eslint-disable-next-line react-hooks/exhaustive-deps

  useMemo(function () {
    return previewType !== state.preview && dispatch({
      preview: previewType
    });
  }, [previewType]); // eslint-disable-next-line react-hooks/exhaustive-deps

  useMemo(function () {
    return height !== state.height && dispatch({
      height: height
    });
  }, [height]); // eslint-disable-next-line react-hooks/exhaustive-deps

  useMemo(function () {
    return tabSize !== state.tabSize && dispatch({
      tabSize: tabSize
    });
  }, [tabSize]);
  useMemo(function () {
    return highlightEnable !== state.highlightEnable && dispatch({
      highlightEnable: highlightEnable
    });
  }, // eslint-disable-next-line react-hooks/exhaustive-deps
  [highlightEnable]); // eslint-disable-next-line react-hooks/exhaustive-deps

  useMemo(function () {
    return autoFocus !== state.autoFocus && dispatch({
      autoFocus: autoFocus
    });
  }, [autoFocus]);
  useMemo(function () {
    return fullscreen !== state.fullscreen && dispatch({
      fullscreen: fullscreen
    });
  }, // eslint-disable-next-line react-hooks/exhaustive-deps
  [fullscreen]);
  var textareaDomRef = useRef();
  var active = useRef('preview');
  var initScroll = useRef(false);
  useMemo(function () {
    textareaDomRef.current = state.textareaWarp;

    if (state.textareaWarp) {
      state.textareaWarp.addEventListener('mouseover', function () {
        active.current = 'text';
      });
      state.textareaWarp.addEventListener('mouseleave', function () {
        active.current = 'preview';
      });
    }
  }, [state.textareaWarp]);

  var handleScroll = function handleScroll(e, type) {
    if (!enableScrollRef.current) return;
    var textareaDom = textareaDomRef.current;
    var previewDom = previewRef.current ? previewRef.current.mdp.current : undefined;

    if (!initScroll.current) {
      active.current = type;
      initScroll.current = true;
    }

    if (textareaDom && previewDom) {
      var scale = (textareaDom.scrollHeight - textareaDom.offsetHeight) / (previewDom.scrollHeight - previewDom.offsetHeight);

      if (e.target === textareaDom && active.current === 'text') {
        previewDom.scrollTop = textareaDom.scrollTop / scale;
      }

      if (e.target === previewDom && active.current === 'preview') {
        textareaDom.scrollTop = previewDom.scrollTop * scale;
      }

      var scrollTop = 0;

      if (active.current === 'text') {
        scrollTop = textareaDom.scrollTop || 0;
      } else if (active.current === 'preview') {
        scrollTop = previewDom.scrollTop || 0;
      }

      dispatch({
        scrollTop: scrollTop
      });
    }
  };

  return /*#__PURE__*/React.createElement(EditorContext.Provider, {
    value: _objectSpread(_objectSpread({}, state), {}, {
      dispatch: dispatch
    })
  }, /*#__PURE__*/React.createElement("div", _extends({
    ref: container,
    className: cls
  }, other, {
    onClick: function onClick() {
      dispatch({
        barPopup: _objectSpread({}, setGroupPopFalse(state.barPopup))
      });
    },
    style: _objectSpread(_objectSpread({}, other.style), {}, {
      height: state.fullscreen ? '100%' : hideToolbar ? Number(state.height) - toolbarHeight : state.height
    })
  }), !hideToolbar && /*#__PURE__*/React.createElement(Toolbar, {
    prefixCls: prefixCls,
    height: toolbarHeight
  }), /*#__PURE__*/React.createElement("div", {
    className: "".concat(prefixCls, "-content"),
    style: {
      height: state.fullscreen ? "calc(100% - ".concat(toolbarHeight, "px)") : Number(state.height) - toolbarHeight
    }
  }, /(edit|live)/.test(state.preview || '') && /*#__PURE__*/React.createElement(TextArea, _extends({
    className: "".concat(prefixCls, "-input"),
    prefixCls: prefixCls,
    autoFocus: autoFocus
  }, textareaProps, {
    renderTextarea: renderTextarea,
    onScroll: function onScroll(e) {
      return handleScroll(e, 'text');
    }
  })), /(live|preview)/.test(state.preview || '') && /*#__PURE__*/React.createElement(MarkdownPreview, _extends({}, previewOptions, {
    onScroll: function onScroll(e) {
      return handleScroll(e, 'preview');
    },
    ref: previewRef,
    source: state.markdown || '',
    className: "".concat(prefixCls, "-preview")
  }))), visiableDragbar && !state.fullscreen && /*#__PURE__*/React.createElement(DragBar, {
    prefixCls: prefixCls,
    height: state.height,
    maxHeight: maxHeight,
    minHeight: minHeight,
    onChange: function onChange(newHeight) {
      dispatch({
        height: newHeight
      });
    }
  })));
};

var mdEditor = /*#__PURE__*/React.forwardRef(InternalMDEditor);
mdEditor.Markdown = MarkdownPreview;
export default mdEditor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FZGl0b3IudHN4Il0sIm5hbWVzIjpbIlJlYWN0IiwidXNlRWZmZWN0IiwidXNlUmVkdWNlciIsInVzZU1lbW8iLCJ1c2VSZWYiLCJ1c2VJbXBlcmF0aXZlSGFuZGxlIiwiTWFya2Rvd25QcmV2aWV3IiwiVGV4dEFyZWEiLCJUb29sYmFyIiwiRHJhZ0JhciIsImdldENvbW1hbmRzIiwiZ2V0RXh0cmFDb21tYW5kcyIsInJlZHVjZXIiLCJFZGl0b3JDb250ZXh0Iiwic2V0R3JvdXBQb3BGYWxzZSIsImRhdGEiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImtleW5hbWUiLCJJbnRlcm5hbE1ERWRpdG9yIiwicHJvcHMiLCJyZWYiLCJwcmVmaXhDbHMiLCJjbGFzc05hbWUiLCJwcm9wc1ZhbHVlIiwidmFsdWUiLCJjb21tYW5kcyIsImV4dHJhQ29tbWFuZHMiLCJoZWlnaHQiLCJ0b29sYmFySGVpZ2h0IiwiZW5hYmxlU2Nyb2xsIiwidmlzaWFibGVEcmFnYmFyIiwiaGlnaGxpZ2h0RW5hYmxlIiwicHJldmlldyIsInByZXZpZXdUeXBlIiwiZnVsbHNjcmVlbiIsInByZXZpZXdPcHRpb25zIiwidGV4dGFyZWFQcm9wcyIsIm1heEhlaWdodCIsIm1pbkhlaWdodCIsImF1dG9Gb2N1cyIsInRhYlNpemUiLCJvbkNoYW5nZSIsImhpZGVUb29sYmFyIiwicmVuZGVyVGV4dGFyZWEiLCJvdGhlciIsIm1hcmtkb3duIiwic2Nyb2xsVG9wIiwic2Nyb2xsVG9wUHJldmlldyIsImJhclBvcHVwIiwic3RhdGUiLCJkaXNwYXRjaCIsImNvbnRhaW5lciIsInByZXZpZXdSZWYiLCJlbmFibGVTY3JvbGxSZWYiLCJjdXJyZW50Iiwic3RhdGVJbml0IiwidW5kZWZpbmVkIiwiY2xzIiwiZmlsdGVyIiwiQm9vbGVhbiIsImpvaW4iLCJ0cmltIiwidGV4dGFyZWFEb21SZWYiLCJhY3RpdmUiLCJpbml0U2Nyb2xsIiwidGV4dGFyZWFXYXJwIiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZVNjcm9sbCIsImUiLCJ0eXBlIiwidGV4dGFyZWFEb20iLCJwcmV2aWV3RG9tIiwibWRwIiwic2NhbGUiLCJzY3JvbGxIZWlnaHQiLCJvZmZzZXRIZWlnaHQiLCJ0YXJnZXQiLCJzdHlsZSIsIk51bWJlciIsInRlc3QiLCJuZXdIZWlnaHQiLCJtZEVkaXRvciIsImZvcndhcmRSZWYiLCJNYXJrZG93biJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPQSxLQUFQLElBQWdCQyxTQUFoQixFQUEyQkMsVUFBM0IsRUFBdUNDLE9BQXZDLEVBQWdEQyxNQUFoRCxFQUF3REMsbUJBQXhELFFBQW1GLE9BQW5GO0FBQ0EsT0FBT0MsZUFBUCxNQUEwRSw2QkFBMUU7QUFFQSxPQUFPQyxRQUFQLE1BQXlDLHVCQUF6QztBQUNBLE9BQU9DLE9BQVAsTUFBb0Isc0JBQXBCO0FBQ0EsT0FBT0MsT0FBUCxNQUFvQixzQkFBcEI7QUFDQSxTQUFTQyxXQUFULEVBQXNCQyxnQkFBdEIsUUFBd0QsWUFBeEQ7QUFDQSxTQUFTQyxPQUFULEVBQWtCQyxhQUFsQixRQUFrRSxXQUFsRTtBQUNBOztBQWtGQSxTQUFTQyxnQkFBVCxHQUE4RDtBQUFBLE1BQXBDQyxJQUFvQyx1RUFBSixFQUFJO0FBQzVEQyxFQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsSUFBWixFQUFrQkcsT0FBbEIsQ0FBMEIsVUFBQ0MsT0FBRCxFQUFhO0FBQ3JDSixJQUFBQSxJQUFJLENBQUNJLE9BQUQsQ0FBSixHQUFnQixLQUFoQjtBQUNELEdBRkQ7QUFHQSxTQUFPSixJQUFQO0FBQ0Q7O0FBRUQsSUFBTUssZ0JBQWdCLEdBQUcsU0FBbkJBLGdCQUFtQixDQUN2QkMsS0FEdUIsRUFFdkJDLEdBRnVCLEVBR3BCO0FBQ0gsYUF1QklELEtBQUssSUFBSSxFQXZCYjtBQUFBLDRCQUNFRSxTQURGO0FBQUEsTUFDRUEsU0FERiwrQkFDYyxhQURkO0FBQUEsTUFFRUMsU0FGRixRQUVFQSxTQUZGO0FBQUEsTUFHU0MsVUFIVCxRQUdFQyxL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LEVBQUVILEtBQUssQ0FBQ0osUUFBTixJQUFrQixFQUo1QjtBQUtFLElBQUEsU0FBUyxZQUFLeEIsU0FBTDtBQUxYLEtBakJKLENBYkYsRUF1Q0dTLGVBQWUsSUFBSSxDQUFDbUIsS0FBSyxDQUFDZixVQUExQixpQkFDQyxvQkFBQyxPQUFEO0FBQ0UsSUFBQSxTQUFTLEVBQUViLFNBRGI7QUFFRSxJQUFBLE1BQU0sRUFBRTRCLEtBQUssQ0FBQ3RCLE1BRmhCO0FBR0UsSUFBQSxTQUFTLEVBQUVVLFNBSGI7QUFJRSxJQUFBLFNBQVMsRUFBRUMsU0FKYjtBQUtFLElBQUEsUUFBUSxFQUFFLGtCQUFDMEMsU0FBRCxFQUFlO0FBQ3ZCOUIsTUFBQUEsUUFBUSxDQUFDO0FBQUV2QixRQUFBQSxNQUFNLEVBQUVxRDtBQUFWLE9BQUQsQ0FBUjtBQUNEO0FBUEgsSUF4Q0osQ0FERixDQURGO0FBdURELENBaE1EOztBQWtNQSxJQUFNQyxRQUFRLGdCQUFHbkYsS0FBSyxDQUFDb0YsVUFBTixDQUE4Q2hFLGdCQUE5QyxDQUFqQjtBQU1DK0QsUUFBRCxDQUF1QkUsUUFBdkIsR0FBa0MvRSxlQUFsQztBQUVBLGVBQWU2RSxRQUFmIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZUVmZmVjdCwgdXNlUmVkdWNlciwgdXNlTWVtbywgdXNlUmVmLCB1c2VJbXBlcmF0aXZlSGFuZGxlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IE1hcmtkb3duUHJldmlldywgeyBNYXJrZG93blByZXZpZXdQcm9wcywgTWFya2Rvd25QcmV2aWV3UmVmIH0gZnJvbSAnQHVpdy9yZWFjdC1tYXJrZG93bi1wcmV2aWV3JztcbmltcG9ydCB7IElQcm9wcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFRleHRBcmVhLCB7IElUZXh0QXJlYVByb3BzIH0gZnJvbSAnLi9jb21wb25lbnRzL1RleHRBcmVhJztcbmltcG9ydCBUb29sYmFyIGZyb20gJy4vY29tcG9uZW50cy9Ub29sYmFyJztcbmltcG9ydCBEcmFnQmFyIGZyb20gJy4vY29tcG9uZW50cy9EcmFnQmFyJztcbmltcG9ydCB7IGdldENvbW1hbmRzLCBnZXRFeHRyYUNvbW1hbmRzLCBJQ29tbWFuZCB9IGZyb20gJy4vY29tbWFuZHMnO1xuaW1wb3J0IHsgcmVkdWNlciwgRWRpdG9yQ29udGV4dCwgQ29udGV4dFN0b3JlLCBQcmV2aWV3VHlwZSB9IGZyb20gJy4vQ29udGV4dCc7XG5pbXBvcnQgJy4vaW5kZXgubGVzcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTURFZGl0b3JQcm9wcyBleHRlbmRzIE9taXQ8UmVhY3QuSFRNTEF0dHJpYnV0ZXM8SFRNTERpdkVsZW1lbnQ+LCAnb25DaGFuZ2UnPiwgSVByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBNYXJrZG93biB2YWx1ZS5cbiAgICovXG4gIHZhbHVlPzogc3RyaW5nO1xuICAvKipcbiAgICogRXZlbnQgaGFuZGxlciBmb3IgdGhlIGBvbkNoYW5nZWAgZXZlbnQuXG4gICAqL1xuICBvbkNoYW5nZT86ICh2YWx1ZT86IHN0cmluZykgPT4gdm9pZDtcbiAgLyoqXG4gICAqIENhbiBiZSB1c2VkIHRvIG1ha2UgYE1hcmtkb3duIEVkaXRvcmAgZm9jdXMgaXRzZWxmIG9uIGluaXRpYWxpemF0aW9uLiBEZWZhdWx0cyB0byBvbi5cbiAgICogaXQgd2lsbCBiZSBzZXQgdG8gdHJ1ZSB3aGVuIGVpdGhlciB0aGUgc291cmNlIGB0ZXh0YXJlYWAgaXMgZm9jdXNlZCxcbiAgICogb3IgaXQgaGFzIGFuIGBhdXRvZm9jdXNgIGF0dHJpYnV0ZSBhbmQgbm8gb3RoZXIgZWxlbWVudCBpcyBmb2N1c2VkLlxuICAgKi9cbiAgYXV0b0ZvY3VzPzogSVRleHRBcmVhUHJvcHNbJ2F1dG9Gb2N1cyddO1xuICAvKipcbiAgICogVGhlIGhlaWdodCBvZiB0aGUgZWRpdG9yLlxuICAgKi9cbiAgaGVpZ2h0PzogbnVtYmVyO1xuICAvKipcbiAgICogQ3VzdG9tIHRvb2xiYXIgaGVpZ3RoXG4gICAqIEBkZWZhdWx0IDI5cHhcbiAgICovXG4gIHRvb2xiYXJIZWlnaHQ/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBTaG93IGRyYWcgYW5kIGRyb3AgdG9vbC4gU2V0IHRoZSBoZWlnaHQgb2YgdGhlIGVkaXRvci5cbiAgICovXG4gIHZpc2lhYmxlRHJhZ2Jhcj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBTaG93IG1hcmtkb3duIHByZXZpZXcuXG4gICAqL1xuICBwcmV2aWV3PzogUHJldmlld1R5cGU7XG4gIC8qKlxuICAgKiBGdWxsIHNjcmVlbiBkaXNwbGF5IGVkaXRvci5cbiAgICovXG4gIGZ1bGxzY3JlZW4/OiBib29sZWFuO1xuICAvKipcbiAgICogTWF4aW11bSBkcmFnIGhlaWdodC4gYHZpc2lhYmxlRHJhZ2Jhcj10cnVlYFxuICAgKi9cbiAgbWF4SGVpZ2h0PzogbnVtYmVyO1xuICAvKipcbiAgICogTWluaW11bSBkcmFnIGhlaWdodC4gYHZpc2lhYmxlRHJhZ2Jhcj10cnVlYFxuICAgKi9cbiAgbWluSGVpZ2h0PzogbnVtYmVyO1xuICAvKipcbiAgICogVGhpcyBpcyByZXNldCBbcmVhY3QtbWFya2Rvd25dKGh0dHBzOi8vZ2l0aHViLmNvbS9yZXh4YXJzL3JlYWN0LW1hcmtkb3duKSBzZXR0aW5ncy5cbiAgICovXG4gIHByZXZpZXdPcHRpb25zPzogT21pdDxNYXJrZG93blByZXZpZXdQcm9wcywgJ3NvdXJjZSc+O1xuICAvKipcbiAgICogU2V0IHRoZSBgdGV4dGFyZWFgIHJlbGF0ZWQgcHJvcHMuXG4gICAqL1xuICB0ZXh0YXJlYVByb3BzPzogSVRleHRBcmVhUHJvcHM7XG4gIC8qKiBVc2UgZGl2IHRvIHJlcGxhY2UgVGV4dEFyZWEgb3IgcmUtcmVuZGVyIFRleHRBcmVhICovXG4gIHJlbmRlclRleHRhcmVhPzogSVRleHRBcmVhUHJvcHNbJ3JlbmRlclRleHRhcmVhJ107XG4gIC8qKlxuICAgKiBEaXNhYmxlIGVkaXRpbmcgYXJlYSBjb2RlIGhpZ2hsaWdodGluZy4gVGhlIHZhbHVlIGlzIGBmYWxzZWAsIHdoaWNoIGluY3JlYXNlcyB0aGUgZWRpdGluZyBzcGVlZC5cbiAgICogQGRlZmF1bHQgdHJ1ZVxuICAgKi9cbiAgaGlnaGxpZ2h0RW5hYmxlPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgY2hhcmFjdGVycyB0byBpbnNlcnQgd2hlbiBwcmVzc2luZyB0YWIga2V5LlxuICAgKiBEZWZhdWx0IGAyYCBzcGFjZXMuXG4gICAqL1xuICB0YWJTaXplPzogbnVtYmVyO1xuICAvKipcbiAgICogWW91IGNhbiBjcmVhdGUgeW91ciBvd24gY29tbWFuZHMgb3IgcmV1c2UgZXhpc3RpbmcgY29tbWFuZHMuXG4gICAqL1xuICBjb21tYW5kcz86IElDb21tYW5kW107XG4gIC8qKlxuICAgKiBZb3UgY2FuIGNyZWF0ZSB5b3VyIG93biBjb21tYW5kcyBvciByZXVzZSBleGlzdGluZyBjb21tYW5kcy5cbiAgICovXG4gIGV4dHJhQ29tbWFuZHM/OiBJQ29tbWFuZFtdO1xuICAvKipcbiAgICogSGlkZSB0aGUgdG9vbCBiYXJcbiAgICovXG4gIGhpZGVUb29sYmFyPzogYm9vbGVhbjtcbiAgLyoqIFdoZXRoZXIgdG8gZW5hYmxlIHNjcm9sbGluZyAqL1xuICBlbmFibGVTY3JvbGw/OiBib29sZWFuO1xufVxuXG5mdW5jdGlvbiBzZXRHcm91cFBvcEZhbHNlKGRhdGE6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+ID0ge30pIHtcbiAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaCgoa2V5bmFtZSkgPT4ge1xuICAgIGRhdGFba2V5bmFtZV0gPSBmYWxzZTtcbiAgfSk7XG4gIHJldHVybiBkYXRhO1xufVxuXG5jb25zdCBJbnRlcm5hbE1ERWRpdG9yID0gKFxuICBwcm9wczogTURFZGl0b3JQcm9wcyxcbiAgcmVmPzogKChpbnN0YW5jZTogQ29udGV4dFN0b3JlKSA9PiB2b2lkKSB8IFJlYWN0LlJlZk9iamVjdDxDb250ZXh0U3RvcmU+IHwgbnVsbCxcbikgPT4ge1xuICBjb25zdCB7XG4gICAgcHJlZml4Q2xzID0gJ3ctbWQtZWRpdG9yJyxcbiAgICBjbGFzc05hbWUsXG4gICAgdmFsdWU6IHByb3BzVmFsdWUsXG4gICAgY29tbWFuZHMgPSBnZXRDb21tYW5kcygpLFxuICAgIGV4dHJhQ29tbWFuZHMgPSBnZXRFeHRyYUNvbW1hbmRzKCksXG4gICAgaGVpZ2h0ID0gMjAwLFxuICAgIHRvb2xiYXJIZWlnaHQgPSAyOSxcbiAgICBlbmFibGVTY3JvbGwgPSB0cnVlLFxuICAgIHZpc2lhYmxlRHJhZ2JhciA9IHRydWUsXG4gICAgaGlnaGxpZ2h0RW5hYmxlID0gdHJ1ZSxcbiAgICBwcmV2aWV3OiBwcmV2aWV3VHlwZSA9ICdsaXZlJyxcbiAgICBmdWxsc2NyZWVuID0gZmFsc2UsXG4gICAgcHJldmlld09wdGlvbnMgPSB7fSxcbiAgICB0ZXh0YXJlYVByb3BzLFxuICAgIG1heEhlaWdodCA9IDEyMDAsXG4gICAgbWluSGVpZ2h0ID0gMTAwLFxuICAgIGF1dG9Gb2N1cyxcbiAgICB0YWJTaXplID0gMixcbiAgICBvbkNoYW5nZSxcbiAgICBoaWRlVG9vbGJhcixcbiAgICByZW5kZXJUZXh0YXJlYSxcbiAgICAuLi5vdGhlclxuICB9ID0gcHJvcHMgfHwge307XG4gIGxldCBbc3RhdGUsIGRpc3BhdGNoXSA9IHVzZVJlZHVjZXIocmVkdWNlciwge1xuICAgIG1hcmtkb3duOiBwcm9wc1ZhbHVlLFxuICAgIHByZXZpZXc6IHByZXZpZXdUeXBlLFxuICAgIGhlaWdodCxcbiAgICBoaWdobGlnaHRFbmFibGUsXG4gICAgdGFiU2l6ZSxcbiAgICBzY3JvbGxUb3A6IDAsXG4gICAgc2Nyb2xsVG9wUHJldmlldzogMCxcbiAgICBjb21tYW5kcyxcbiAgICBleHRyYUNvbW1hbmRzLFxuICAgIGZ1bGxzY3JlZW4sXG4gICAgb25DaGFuZ2UsXG4gICAgYmFyUG9wdXA6IHt9LFxuICB9KTtcbiAgY29uc3QgY29udGFpbmVyID0gdXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKTtcbiAgY29uc3QgcHJldmlld1JlZiA9IHVzZVJlZjxNYXJrZG93blByZXZpZXdSZWY+KG51bGwpO1xuICBjb25zdCBlbmFibGVTY3JvbGxSZWYgPSB1c2VSZWYoZW5hYmxlU2Nyb2xsKTtcblxuICB1c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgKCkgPT4gKHsgLi4uc3RhdGUgfSkpO1xuICB1c2VNZW1vKCgpID0+IChlbmFibGVTY3JvbGxSZWYuY3VycmVudCA9IGVuYWJsZVNjcm9sbCksIFtlbmFibGVTY3JvbGxdKTtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBzdGF0ZUluaXQ6IENvbnRleHRTdG9yZSA9IHt9O1xuICAgIGlmIChjb250YWluZXIuY3VycmVudCkge1xuICAgICAgc3RhdGVJbml0LmNvbnRhaW5lciA9IGNvbnRhaW5lci5jdXJyZW50IHx8IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgc3RhdGVJbml0Lm1hcmtkb3duID0gcHJvcHNWYWx1ZSB8fCAnJztcbiAgICBzdGF0ZUluaXQuYmFyUG9wdXAgPSB7fTtcbiAgICBpZiAoZGlzcGF0Y2gpIHtcbiAgICAgIGRpc3BhdGNoKHsgLi4uc3RhdGUsIC4uLnN0YXRlSW5pdCB9KTtcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICB9LCBbXSk7XG5cbiAgY29uc3QgY2xzID0gW1xuICAgIGNsYXNzTmFtZSxcbiAgICBwcmVmaXhDbHMsXG4gICAgc3RhdGUucHJldmlldyA/IGAke3ByZWZpeENsc30tc2hvdy0ke3N0YXRlLnByZXZpZXd9YCA6IG51bGwsXG4gICAgc3RhdGUuZnVsbHNjcmVlbiA/IGAke3ByZWZpeENsc30tZnVsbHNjcmVlbmAgOiBudWxsLFxuICBdXG4gICAgLmZpbHRlcihCb29sZWFuKVxuICAgIC5qb2luKCcgJylcbiAgICAudHJpbSgpO1xuXG4gIHVzZU1lbW8oXG4gICAgKCkgPT4gcHJvcHNWYWx1ZSAhPT0gc3RhdGUubWFya2Rvd24gJiYgZGlzcGF0Y2goeyBtYXJrZG93bjogcHJvcHNWYWx1ZSB8fCAnJyB9KSxcbiAgICBbcHJvcHNWYWx1ZSwgc3RhdGUubWFya2Rvd25dLFxuICApO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gIHVzZU1lbW8oKCkgPT4gcHJldmlld1R5cGUgIT09IHN0YXRlLnByZXZpZXcgJiYgZGlzcGF0Y2goeyBwcmV2aWV3OiBwcmV2aWV3VHlwZSB9KSwgW3ByZXZpZXdUeXBlXSk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgdXNlTWVtbygoKSA9PiBoZWlnaHQgIT09IHN0YXRlLmhlaWdodCAmJiBkaXNwYXRjaCh7IGhlaWdodDogaGVpZ2h0IH0pLCBbaGVpZ2h0XSk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgdXNlTWVtbygoKSA9PiB0YWJTaXplICE9PSBzdGF0ZS50YWJTaXplICYmIGRpc3BhdGNoKHsgdGFiU2l6ZSB9KSwgW3RhYlNpemVdKTtcbiAgdXNlTWVtbyhcbiAgICAoKSA9PiBoaWdobGlnaHRFbmFibGUgIT09IHN0YXRlLmhpZ2hsaWdodEVuYWJsZSAmJiBkaXNwYXRjaCh7IGhpZ2hsaWdodEVuYWJsZSB9KSxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gICAgW2hpZ2hsaWdodEVuYWJsZV0sXG4gICk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgdXNlTWVtbygoKSA9PiBhdXRvRm9jdXMgIT09IHN0YXRlLmF1dG9Gb2N1cyAmJiBkaXNwYXRjaCh7IGF1dG9Gb2N1czogYXV0b0ZvY3VzIH0pLCBbYXV0b0ZvY3VzXSk7XG4gIHVzZU1lbW8oXG4gICAgKCkgPT4gZnVsbHNjcmVlbiAhPT0gc3RhdGUuZnVsbHNjcmVlbiAmJiBkaXNwYXRjaCh7IGZ1bGxzY3JlZW46IGZ1bGxzY3JlZW4gfSksXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICAgIFtmdWxsc2NyZWVuXSxcbiAgKTtcblxuICBjb25zdCB0ZXh0YXJlYURvbVJlZiA9IHVzZVJlZjxIVE1MRGl2RWxlbWVudD4oKTtcbiAgY29uc3QgYWN0aXZlID0gdXNlUmVmPCd0ZXh0JyB8ICdwcmV2aWV3Jz4oJ3ByZXZpZXcnKTtcbiAgY29uc3QgaW5pdFNjcm9sbCA9IHVzZVJlZihmYWxzZSk7XG5cbiAgdXNlTWVtbygoKSA9PiB7XG4gICAgdGV4dGFyZWFEb21SZWYuY3VycmVudCA9IHN0YXRlLnRleHRhcmVhV2FycDtcbiAgICBpZiAoc3RhdGUudGV4dGFyZWFXYXJwKSB7XG4gICAgICBzdGF0ZS50ZXh0YXJlYVdhcnAuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdmVyJywgKCkgPT4ge1xuICAgICAgICBhY3RpdmUuY3VycmVudCA9ICd0ZXh0JztcbiAgICAgIH0pO1xuICAgICAgc3RhdGUudGV4dGFyZWFXYXJwLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoKSA9PiB7XG4gICAgICAgIGFjdGl2ZS5jdXJyZW50ID0gJ3ByZXZpZXcnO1xuICAgICAgfSk7XG4gICAgfVxuICB9LCBbc3RhdGUudGV4dGFyZWFXYXJwXSk7XG5cbiAgY29uc3QgaGFuZGxlU2Nyb2xsID0gKGU6IFJlYWN0LlVJRXZlbnQ8SFRNTERpdkVsZW1lbnQ+LCB0eXBlOiAndGV4dCcgfCAncHJldmlldycpID0+IHtcbiAgICBpZiAoIWVuYWJsZVNjcm9sbFJlZi5jdXJyZW50KSByZXR1cm47XG4gICAgY29uc3QgdGV4dGFyZWFEb20gPSB0ZXh0YXJlYURvbVJlZi5jdXJyZW50O1xuICAgIGNvbnN0IHByZXZpZXdEb20gPSBwcmV2aWV3UmVmLmN1cnJlbnQgPyBwcmV2aWV3UmVmLmN1cnJlbnQubWRwLmN1cnJlbnQgOiB1bmRlZmluZWQ7XG4gICAgaWYgKCFpbml0U2Nyb2xsLmN1cnJlbnQpIHtcbiAgICAgIGFjdGl2ZS5jdXJyZW50ID0gdHlwZTtcbiAgICAgIGluaXRTY3JvbGwuY3VycmVudCA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0ZXh0YXJlYURvbSAmJiBwcmV2aWV3RG9tKSB7XG4gICAgICBjb25zdCBzY2FsZSA9XG4gICAgICAgICh0ZXh0YXJlYURvbS5zY3JvbGxIZWlnaHQgLSB0ZXh0YXJlYURvbS5vZmZzZXRIZWlnaHQpIC8gKHByZXZpZXdEb20uc2Nyb2xsSGVpZ2h0IC0gcHJldmlld0RvbS5vZmZzZXRIZWlnaHQpO1xuICAgICAgaWYgKGUudGFyZ2V0ID09PSB0ZXh0YXJlYURvbSAmJiBhY3RpdmUuY3VycmVudCA9PT0gJ3RleHQnKSB7XG4gICAgICAgIHByZXZpZXdEb20uc2Nyb2xsVG9wID0gdGV4dGFyZWFEb20uc2Nyb2xsVG9wIC8gc2NhbGU7XG4gICAgICB9XG4gICAgICBpZiAoZS50YXJnZXQgPT09IHByZXZpZXdEb20gJiYgYWN0aXZlLmN1cnJlbnQgPT09ICdwcmV2aWV3Jykge1xuICAgICAgICB0ZXh0YXJlYURvbS5zY3JvbGxUb3AgPSBwcmV2aWV3RG9tLnNjcm9sbFRvcCAqIHNjYWxlO1xuICAgICAgfVxuICAgICAgbGV0IHNjcm9sbFRvcCA9IDA7XG4gICAgICBpZiAoYWN0aXZlLmN1cnJlbnQgPT09ICd0ZXh0Jykge1xuICAgICAgICBzY3JvbGxUb3AgPSB0ZXh0YXJlYURvbS5zY3JvbGxUb3AgfHwgMDtcbiAgICAgIH0gZWxzZSBpZiAoYWN0aXZlLmN1cnJlbnQgPT09ICdwcmV2aWV3Jykge1xuICAgICAgICBzY3JvbGxUb3AgPSBwcmV2aWV3RG9tLnNjcm9sbFRvcCB8fCAwO1xuICAgICAgfVxuICAgICAgZGlzcGF0Y2goeyBzY3JvbGxUb3AgfSk7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiAoXG4gICAgPEVkaXRvckNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e3sgLi4uc3RhdGUsIGRpc3BhdGNoIH19PlxuICAgICAgPGRpdlxuICAgICAgICByZWY9e2NvbnRhaW5lcn1cbiAgICAgICAgY2xhc3NOYW1lPXtjbHN9XG4gICAgICAgIHsuLi5vdGhlcn1cbiAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgIGRpc3BhdGNoKHsgYmFyUG9wdXA6IHsgLi4uc2V0R3JvdXBQb3BGYWxzZShzdGF0ZS5iYXJQb3B1cCkgfSB9KTtcbiAgICAgICAgfX1cbiAgICAgICAgc3R5bGU9e3tcbiAgICAgICAgICAuLi5vdGhlci5zdHlsZSxcbiAgICAgICAgICBoZWlnaHQ6IHN0YXRlLmZ1bGxzY3JlZW4gPyAnMTAwJScgOiBoaWRlVG9vbGJhciA/IE51bWJlcihzdGF0ZS5oZWlnaHQpIC0gdG9vbGJhckhlaWdodCA6IHN0YXRlLmhlaWdodCxcbiAgICAgICAgfX1cbiAgICAgID5cbiAgICAgICAgeyFoaWRlVG9vbGJhciAmJiA8VG9vbGJhciBwcmVmaXhDbHM9e3ByZWZpeENsc30gaGVpZ2h0PXt0b29sYmFySGVpZ2h0fSAvPn1cbiAgICAgICAgPGRpdlxuICAgICAgICAgIGNsYXNzTmFtZT17YCR7cHJlZml4Q2xzfS1jb250ZW50YH1cbiAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgaGVpZ2h0OiBzdGF0ZS5mdWxsc2NyZWVuID8gYGNhbGMoMTAwJSAtICR7dG9vbGJhckhlaWdodH1weClgIDogTnVtYmVyKHN0YXRlLmhlaWdodCkgLSB0b29sYmFySGVpZ2h0LFxuICAgICAgICAgIH19XG4gICAgICAgID5cbiAgICAgICAgICB7LyhlZGl0fGxpdmUpLy50ZXN0KHN0YXRlLnByZXZpZXcgfHwgJycpICYmIChcbiAgICAgICAgICAgIDxUZXh0QXJlYVxuICAgICAgICAgICAgICBjbGFzc05hbWU9e2Ake3ByZWZpeENsc30taW5wdXRgfVxuICAgICAgICAgICAgICBwcmVmaXhDbHM9e3ByZWZpeENsc31cbiAgICAgICAgICAgICAgYXV0b0ZvY3VzPXthdXRvRm9jdXN9XG4gICAgICAgICAgICAgIHsuLi50ZXh0YXJlYVByb3BzfVxuICAgICAgICAgICAgICByZW5kZXJUZXh0YXJlYT17cmVuZGVyVGV4dGFyZWF9XG4gICAgICAgICAgICAgIG9uU2Nyb2xsPXsoZSkgPT4gaGFuZGxlU2Nyb2xsKGUsICd0ZXh0Jyl9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICl9XG4gICAgICAgICAgey8obGl2ZXxwcmV2aWV3KS8udGVzdChzdGF0ZS5wcmV2aWV3IHx8ICcnKSAmJiAoXG4gICAgICAgICAgICA8TWFya2Rvd25QcmV2aWV3XG4gICAgICAgICAgICAgIHsuLi4ocHJldmlld09wdGlvbnMgYXMgdW5rbm93bil9XG4gICAgICAgICAgICAgIG9uU2Nyb2xsPXsoZSkgPT4gaGFuZGxlU2Nyb2xsKGUsICdwcmV2aWV3Jyl9XG4gICAgICAgICAgICAgIHJlZj17cHJldmlld1JlZn1cbiAgICAgICAgICAgICAgc291cmNlPXtzdGF0ZS5tYXJrZG93biB8fCAnJ31cbiAgICAgICAgICAgICAgY2xhc3NOYW1lPXtgJHtwcmVmaXhDbHN9LXByZXZpZXdgfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApfVxuICAgICAgICA8L2Rpdj5cbiAgICAgICAge3Zpc2lhYmxlRHJhZ2JhciAmJiAhc3RhdGUuZnVsbHNjcmVlbiAmJiAoXG4gICAgICAgICAgPERyYWdCYXJcbiAgICAgICAgICAgIHByZWZpeENscz17cHJlZml4Q2xzfVxuICAgICAgICAgICAgaGVpZ2h0PXtzdGF0ZS5oZWlnaHQgYXMgbnVtYmVyfVxuICAgICAgICAgICAgbWF4SGVpZ2h0PXttYXhIZWlnaHQhfVxuICAgICAgICAgICAgbWluSGVpZ2h0PXttaW5IZWlnaHQhfVxuICAgICAgICAgICAgb25DaGFuZ2U9eyhuZXdIZWlnaHQpID0+IHtcbiAgICAgICAgICAgICAgZGlzcGF0Y2goeyBoZWlnaHQ6IG5ld0hlaWdodCB9KTtcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgIDwvZGl2PlxuICAgIDwvRWRpdG9yQ29udGV4dC5Qcm92aWRlcj5cbiAgKTtcbn07XG5cbmNvbnN0IG1kRWRpdG9yID0gUmVhY3QuZm9yd2FyZFJlZjxDb250ZXh0U3RvcmUsIE1ERWRpdG9yUHJvcHM+KEludGVybmFsTURFZGl0b3IpO1xuXG50eXBlIE1ERWRpdG9yID0gdHlwZW9mIG1kRWRpdG9yICYge1xuICBNYXJrZG93bjogdHlwZW9mIE1hcmtkb3duUHJldmlldztcbn07XG5cbihtZEVkaXRvciBhcyBNREVkaXRvcikuTWFya2Rvd24gPSBNYXJrZG93blByZXZpZXc7XG5cbmV4cG9ydCBkZWZhdWx0IG1kRWRpdG9yIGFzIE1ERWRpdG9yO1xuIl19